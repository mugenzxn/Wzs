<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WASL Transport - Plateforme Professionnelle</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600;700;900&display=swap" rel="stylesheet">
    <style>
        *{margin:0;padding:0;box-sizing:border-box}html{scroll-behavior:smooth}body{font-family:'Outfit',sans-serif}
        .modal{display:none;position:fixed;z-index:100;inset:0;background:rgba(0,0,0,.7);backdrop-filter:blur(10px);animation:fadeIn .3s}
        .modal.active{display:flex;align-items:center;justify-content:center}
        .modal-content{background:#fff;padding:2rem;border-radius:1.5rem;max-width:550px;width:94%;max-height:92vh;overflow-y:auto;animation:slideIn .4s cubic-bezier(.34,1.56,.64,1);box-shadow:0 25px 50px -12px rgba(0,0,0,.35)}
        .modal-lg{max-width:900px}.modal-xl{max-width:1100px}.modal-xxl{max-width:1300px}
        @keyframes fadeIn{from{opacity:0}to{opacity:1}}
        @keyframes slideIn{from{transform:translateY(-60px) scale(.95);opacity:0}to{transform:translateY(0) scale(1);opacity:1}}
        @keyframes float{0%,100%{transform:translateY(0)}50%{transform:translateY(-20px)}}
        @keyframes pulse2{0%,100%{opacity:1;transform:scale(1)}50%{opacity:.5;transform:scale(1.1)}}
        .hero-gradient{background:linear-gradient(135deg,#0f172a,#1e293b 50%,#334155);position:relative;overflow:hidden}
        .hero-gradient::before{content:'';position:absolute;inset:0;background:url('https://images.unsplash.com/photo-1586528116311-ad8dd3c8310d?w=1000&q=80') center/cover;opacity:.15;mix-blend-mode:overlay}
        .card-hover{transition:all .4s cubic-bezier(.34,1.56,.64,1)}.card-hover:hover{transform:translateY(-12px) scale(1.02);box-shadow:0 30px 60px -15px rgba(0,0,0,.3)}
        .service-card{position:relative;overflow:hidden;border-radius:1.5rem;height:400px}.service-card img{width:100%;height:100%;object-fit:cover;transition:transform .6s}.service-card:hover img{transform:scale(1.1)}
        .service-overlay{position:absolute;bottom:0;left:0;right:0;background:linear-gradient(to top,rgba(0,0,0,.9),transparent);padding:2rem;color:#fff}
        .nav-scrolled{background:rgba(255,255,255,.98)!important;backdrop-filter:blur(20px);box-shadow:0 10px 30px rgba(0,0,0,.1)}
        .dashboard-section{display:none}.dashboard-section.active{display:block}
        .role-badge{padding:.35rem .9rem;border-radius:9999px;font-size:.75rem;font-weight:700;letter-spacing:.5px;text-transform:uppercase}
        .role-exp{background:linear-gradient(135deg,#dbeafe,#bfdbfe);color:#1e40af}
        .role-trans{background:linear-gradient(135deg,#dcfce7,#bbf7d0);color:#166534}
        .status-pending{background:linear-gradient(135deg,#FEF3C7,#FDE68A);color:#92400E}
        .status-pending_validation{background:linear-gradient(135deg,#fae8ff,#e9d5ff);color:#7e22ce}
        .status-quoted{background:linear-gradient(135deg,#e0e7ff,#c7d2fe);color:#4338ca}
        .status-accepted{background:linear-gradient(135deg,#dbeafe,#bfdbfe);color:#1e40af}
        .status-progress{background:linear-gradient(135deg,#dbeafe,#bfdbfe);color:#1e40af}
        .status-pending_delivery{background:linear-gradient(135deg,#fed7aa,#fdba74);color:#9a3412}
        .status-delivered{background:linear-gradient(135deg,#dcfce7,#bbf7d0);color:#166534}
        .step-section{display:none}.step-section.active{display:block}
        .demo-creds{background:linear-gradient(135deg,#eff6ff,#dbeafe);border:2px solid #3b82f6;border-radius:1rem;padding:1rem;margin-bottom:1.5rem}
        .cred-item{background:#fff;padding:.75rem;border-radius:.5rem;margin-bottom:.5rem;cursor:pointer;transition:all .2s}.cred-item:hover{transform:translateX(5px);box-shadow:0 4px 12px rgba(59,130,246,.2)}
        @media print{.no-print{display:none!important}body{background:#fff}}
        .pulse-dot{animation:pulse2 2s infinite}
        .tab-btn{padding:.6rem 1rem;font-weight:700;white-space:nowrap;border-bottom:2px solid transparent;transition:all .2s;font-size:.85rem}
        .tab-btn.active{color:#2563eb;border-bottom-color:#2563eb}.tab-btn:not(.active){color:#64748b}.tab-btn:not(.active):hover{color:#334155}
        .offer-card{border:2px solid #e2e8f0;border-radius:1rem;padding:1.25rem;transition:all .2s}.offer-card:hover{border-color:#3b82f6}
        .devis-card{border:2px solid #e2e8f0;border-radius:1rem;padding:1.5rem;cursor:pointer;transition:all .3s}.devis-card:hover{border-color:#3b82f6;transform:translateY(-4px);box-shadow:0 8px 20px rgba(59,130,246,.15)}
        .inp{width:100%;padding:.6rem .8rem;border:2px solid #e2e8f0;border-radius:.75rem;font-size:.85rem;transition:border-color .2s}.inp:focus{border-color:#3b82f6;outline:none}
        .lbl{display:block;font-size:.75rem;font-weight:700;color:#475569;margin-bottom:.25rem}
        .check-row{display:flex;align-items:center;gap:.5rem;padding:.5rem 0;font-size:.85rem}
        .check-row input[type=checkbox]{width:1.1rem;height:1.1rem;accent-color:#2563eb}
        .section-title{font-size:1rem;font-weight:800;color:#1e293b;padding:.75rem 0;border-bottom:2px solid #e2e8f0;margin-bottom:.75rem;display:flex;align-items:center;gap:.5rem}
        .kpi-card{background:#fff;padding:1.25rem;border-radius:1rem;border:1px solid #e2e8f0}
        .kpi-val{font-size:1.5rem;font-weight:900}.kpi-lbl{font-size:.7rem;color:#64748b;margin-top:.15rem}
    </style>
</head>
<body class="bg-slate-50 text-slate-800">

<!-- NAVBAR -->
<nav id="navbar" class="fixed top-0 w-full z-50 transition-all duration-300 bg-transparent">
    <div class="max-w-7xl mx-auto px-6 py-4 flex items-center justify-between">
        <div class="flex items-center gap-3">
            <div class="w-12 h-12 bg-gradient-to-br from-blue-600 to-blue-800 rounded-2xl flex items-center justify-center text-white font-black text-xl shadow-xl">W</div>
            <span class="text-2xl font-black" id="navBrand">WASL Transport</span>
        </div>
        <div id="navPublic" class="flex items-center gap-4">
            <button onclick="openModal('loginModal')" class="bg-white/95 hover:bg-white text-slate-800 px-6 py-2.5 rounded-xl font-bold text-sm shadow-lg transition-all hover:shadow-xl hover:scale-105">Connexion</button>
            <button onclick="openModal('registerModal')" class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-2.5 rounded-xl font-bold text-sm shadow-lg transition-all">Inscription</button>
        </div>
        <div id="navConnected" class="hidden items-center gap-3">
            <div id="roleSwitcher" class="hidden flex items-center gap-1 bg-slate-100 rounded-xl p-1">
                <button onclick="switchActiveRole('expediteur')" id="rsExp" class="px-3 py-1.5 rounded-lg text-xs font-bold transition">ğŸ“¦ ExpÃ©diteur</button>
                <button onclick="switchActiveRole('transporteur')" id="rsTrans" class="px-3 py-1.5 rounded-lg text-xs font-bold transition">ğŸš› Transporteur</button>
            </div>
            <span id="userRole" class="role-badge role-exp"></span>
            <span id="userName" class="text-sm font-semibold text-slate-700"></span>
                <button onclick="resetLocalStorage()" class="bg-orange-500 hover:bg-orange-600 text-white px-4 py-2 rounded-xl font-bold text-xs transition-all">Reset</button>
            <button onclick="logout()" class="bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded-xl font-bold text-xs transition-all">DÃ©connexion</button>
        </div>
    </div>
</nav>

<!-- HERO -->
<section id="heroSection" class="hero-gradient min-h-screen flex items-center relative">
    <div class="absolute inset-0 opacity-20"><div class="absolute top-20 left-20 w-96 h-96 bg-blue-500 rounded-full filter blur-3xl animate-pulse"></div><div class="absolute bottom-20 right-20 w-96 h-96 bg-cyan-500 rounded-full filter blur-3xl" style="animation:float 8s ease-in-out infinite"></div></div>
    <div class="max-w-7xl mx-auto px-6 py-32 relative z-10 w-full">
        <div class="grid lg:grid-cols-2 gap-16 items-center">
            <div>
                <div class="inline-flex items-center gap-2 bg-blue-500/20 text-blue-200 px-5 py-2.5 rounded-full text-sm font-bold mb-6 backdrop-blur-sm border border-blue-400/30"><span class="w-2 h-2 bg-green-400 rounded-full pulse-dot"></span>Commissionnaire de Transport</div>
                <h1 class="text-5xl lg:text-7xl font-black text-white leading-tight mb-6">Transport<br><span class="text-transparent bg-clip-text bg-gradient-to-r from-blue-400 via-cyan-300 to-blue-500">AÃ©rien & Routier</span></h1>
                <p class="text-xl text-slate-200 mb-10 leading-relaxed">Solutions logistiques complÃ¨tes pour vos expÃ©ditions nationales et internationales.</p>
                <div class="flex flex-wrap gap-4">
                    <button onclick="openModal('registerModal')" class="bg-gradient-to-r from-blue-500 to-cyan-600 hover:from-blue-600 hover:to-cyan-700 text-white px-8 py-4 rounded-2xl font-bold text-lg shadow-2xl transition-all hover:scale-105">ğŸš€ CrÃ©er un compte</button>
                    <button onclick="openModal('loginModal')" class="bg-white/10 hover:bg-white/20 text-white border-2 border-white/30 px-8 py-4 rounded-2xl font-bold text-lg transition-all backdrop-blur-sm">Se connecter</button>
                </div>
            </div>
            <div class="hidden lg:grid grid-cols-2 gap-6">
                <div class="space-y-6"><div class="bg-white/10 backdrop-blur-xl p-8 rounded-3xl border border-white/20 card-hover"><div class="text-5xl mb-3">âœˆï¸</div><h3 class="text-white font-black text-3xl mb-1">5,000+</h3><p class="text-slate-300 text-sm">Envois aÃ©riens/an</p></div><div class="bg-white/10 backdrop-blur-xl p-8 rounded-3xl border border-white/20 card-hover"><div class="text-5xl mb-3">ğŸš›</div><h3 class="text-white font-black text-3xl mb-1">15,000+</h3><p class="text-slate-300 text-sm">Transports routiers/an</p></div></div>
                <div class="space-y-6 mt-12"><div class="bg-white/10 backdrop-blur-xl p-8 rounded-3xl border border-white/20 card-hover"><div class="text-5xl mb-3">ğŸ¢</div><h3 class="text-white font-black text-3xl mb-1">800+</h3><p class="text-slate-300 text-sm">Clients professionnels</p></div><div class="bg-white/10 backdrop-blur-xl p-8 rounded-3xl border border-white/20 card-hover"><div class="text-5xl mb-3">ğŸŒ</div><h3 class="text-white font-black text-3xl mb-1">50+</h3><p class="text-slate-300 text-sm">Destinations mondiales</p></div></div>
            </div>
        </div>
    </div>
</section>

<!-- ==================== DASHBOARD EXPÃ‰DITEUR ==================== -->
<section id="dashboardExp" class="dashboard-section pt-24 pb-12 min-h-screen bg-slate-50">
    <div class="max-w-7xl mx-auto px-6">
        <div class="flex justify-between items-center mb-8"><div><h1 class="text-3xl font-black text-slate-900">Mon Espace ExpÃ©diteur</h1><p class="text-slate-500 mt-1">GÃ©rez vos expÃ©ditions</p></div><button onclick="openModal('demandeModal')" class="px-6 py-3 bg-blue-600 text-white rounded-xl font-bold hover:bg-blue-700 transition">+ Nouvelle demande</button></div>
        <div class="grid grid-cols-2 md:grid-cols-6 gap-3 mb-6" id="expStats"></div>
        <div class="flex gap-2 mb-6 border-b border-slate-200"><button onclick="showExpTab('expeditions')" id="expTabExp" class="tab-btn active">ğŸ“¦ ExpÃ©ditions</button><button onclick="showExpTab('documents')" id="expTabDocs" class="tab-btn">ğŸ“„ Documents</button></div>
        <div id="expTabExpContent"><div class="bg-white rounded-2xl shadow-sm border overflow-hidden"><div class="p-4 border-b flex flex-col md:flex-row gap-3 items-center justify-between"><div class="flex gap-1.5 flex-wrap" id="expFilterBtns"></div><input type="text" id="expSearch" oninput="renderExpList()" placeholder="ğŸ” Rechercher..." class="inp w-full md:w-56"></div><div id="expList" class="divide-y"></div><div id="expPag" class="p-3 border-t flex items-center justify-between hidden"><span class="text-xs text-slate-500" id="expPagInfo"></span><div class="flex gap-1"><button onclick="expPg--;renderExpList()" id="expPrev" class="px-3 py-1 rounded border text-xs font-bold disabled:opacity-40" disabled>â†</button><button onclick="expPg++;renderExpList()" id="expNext" class="px-3 py-1 rounded border text-xs font-bold disabled:opacity-40">â†’</button></div></div></div></div>
        <div id="expTabDocsContent" class="hidden"><div class="bg-white rounded-2xl shadow-sm border overflow-hidden"><div class="p-4 border-b"><h2 class="text-lg font-bold">Mes Documents</h2></div><div id="expDocsList"></div></div></div>
    </div>
</section>

<!-- ==================== DASHBOARD TRANSPORTEUR ==================== -->
<section id="dashboardTrans" class="dashboard-section pt-24 pb-12 min-h-screen bg-slate-50">
    <div class="max-w-7xl mx-auto px-6">
        <!-- Pending validation banner -->
        <div id="transPendingBanner" class="hidden mb-6 p-6 bg-gradient-to-r from-purple-50 to-indigo-50 border-2 border-purple-200 rounded-2xl">
            <div class="flex items-center gap-4"><div class="text-4xl">ğŸ”’</div><div><h3 class="font-bold text-purple-900 text-lg">Compte en attente de validation</h3><p class="text-purple-700 text-sm">ComplÃ©tez votre dossier de conformitÃ© pour activer votre compte.</p><button onclick="openModal('conformityModal')" class="mt-3 px-5 py-2.5 bg-purple-600 text-white rounded-xl font-bold text-sm hover:bg-purple-700">ğŸ“‹ Remplir le dossier de conformitÃ©</button></div></div>
        </div>
        <div id="transActiveContent">
            <div class="flex justify-between items-center mb-8"><div><h1 class="text-3xl font-black text-slate-900">Mon Espace Transporteur</h1><p class="text-slate-500 mt-1">Missions et gestion TMS</p></div></div>
            <div class="grid grid-cols-2 md:grid-cols-4 gap-3 mb-6" id="transStats"></div>
            <div class="flex gap-1 mb-6 border-b border-slate-200 overflow-x-auto">
                <button onclick="showTransTab('available')" id="tTabAvail" class="tab-btn active">ğŸ”” Disponibles</button>
                <button onclick="showTransTab('my')" id="tTabMy" class="tab-btn">ğŸ“‹ Mes missions</button>
                <button onclick="showTransTab('tms')" id="tTabTms" class="tab-btn">ğŸ“Š TMS</button>
                <button onclick="showTransTab('chauffeurs')" id="tTabChauf" class="tab-btn">ğŸ‘¤ Chauffeurs</button>
                <button onclick="showTransTab('comptabilite')" id="tTabCompta" class="tab-btn">ğŸ’¶ ComptabilitÃ©</button>
            </div>
            <div id="tAvailC"></div><div id="tMyC" class="hidden"></div><div id="tTmsC" class="hidden"></div><div id="tChaufC" class="hidden"></div><div id="tComptaC" class="hidden"></div>
        </div>
    </div>
</section>

<!-- ==================== DASHBOARD ADMIN ==================== -->
<section id="dashboardAdmin" class="dashboard-section pt-24 pb-12 min-h-screen bg-slate-50">
    <div class="max-w-7xl mx-auto px-6">
        <div class="mb-8"><h1 class="text-3xl font-black text-slate-900">Panel Administrateur</h1></div>
        <div class="grid grid-cols-2 md:grid-cols-5 gap-3 mb-6" id="adminStats"></div>
        <div class="flex gap-1 mb-6 border-b border-slate-200 overflow-x-auto">
            <button onclick="showATab('users')" id="aTabUsers" class="tab-btn active">ğŸ‘¥ Utilisateurs</button>
            <button onclick="showATab('validation')" id="aTabValidation" class="tab-btn">ğŸ”’ ConformitÃ©</button>
            <button onclick="showATab('offres')" id="aTabOffres" class="tab-btn">ğŸ’° Offres</button>
            <button onclick="showATab('assign')" id="aTabAssign" class="tab-btn">âœ… Assignation</button>
            <button onclick="showATab('livraisons')" id="aTabLivraisons" class="tab-btn">ğŸ“· Livraisons</button>
            <button onclick="showATab('facturation')" id="aTabFacturation" class="tab-btn">ğŸ’¶ Facturation</button>
            <button onclick="showATab('docs')" id="aTabDocs" class="tab-btn">ğŸ“„ Documents</button>
        </div>
        <div id="aUsersC" class="a-tab"></div>
        <div id="aValidationC" class="a-tab hidden"></div>
        <div id="aOffresC" class="a-tab hidden"></div>
        <div id="aAssignC" class="a-tab hidden"></div>
        <div id="aLivraisonsC" class="a-tab hidden"></div>
        <div id="aFacturationC" class="a-tab hidden"></div>
        <div id="aDocsC" class="a-tab hidden"></div>
    </div>
</section>

<!-- ==================== ALL MODALS ==================== -->

<!-- LOGIN -->
<div id="loginModal" class="modal"><div class="modal-content">
    <div class="flex justify-between items-center mb-4"><h2 class="text-xl font-black">ğŸ” Connexion</h2><button onclick="closeModal('loginModal')" class="text-slate-400 hover:text-slate-600 text-2xl">&times;</button></div>
    <div class="demo-creds"><div class="flex items-center gap-2 mb-2"><span class="text-lg">ğŸ¯</span><h3 class="font-black text-blue-900 text-sm">Comptes dÃ©mo</h3></div>
        <div class="cred-item" onclick="fillLogin('expediteur@wasl.fr','demo123')"><div class="flex justify-between"><div><div class="font-bold text-blue-900 text-xs">ğŸ“¦ ExpÃ©diteur</div><div class="text-xs text-slate-500">expediteur@wasl.fr</div></div><div class="text-xs text-slate-400">demo123</div></div></div>
        <div class="cred-item" onclick="fillLogin('transporteur@wasl.fr','demo123')"><div class="flex justify-between"><div><div class="font-bold text-emerald-900 text-xs">ğŸš› Transporteur (75)</div><div class="text-xs text-slate-500">transporteur@wasl.fr</div></div><div class="text-xs text-slate-400">demo123</div></div></div>
        <div class="cred-item" onclick="fillLogin('transporteur2@wasl.fr','demo123')"><div class="flex justify-between"><div><div class="font-bold text-emerald-900 text-xs">ğŸš› Transporteur 2 (64)</div><div class="text-xs text-slate-500">transporteur2@wasl.fr</div></div><div class="text-xs text-slate-400">demo123</div></div></div>
        <div class="cred-item" onclick="fillLogin('admin@wasl.fr','admin123')"><div class="flex justify-between"><div><div class="font-bold text-purple-900 text-xs">âš™ï¸ Admin</div><div class="text-xs text-slate-500">admin@wasl.fr</div></div><div class="text-xs text-slate-400">admin123</div></div></div>
    </div>
    <form onsubmit="handleLogin(event)" class="space-y-4">
        <div><label class="lbl">Email</label><input type="email" id="loginEmail" required class="inp"></div>
        <div><label class="lbl">Mot de passe</label><input type="password" id="loginPwd" required class="inp"></div>
        <button type="submit" class="w-full bg-gradient-to-r from-blue-600 to-cyan-600 text-white font-bold py-3.5 rounded-xl shadow-lg hover:scale-105 transition-all">Se connecter</button>
        <p class="text-center text-xs text-slate-600">Pas de compte ? <button type="button" onclick="switchModal('loginModal','registerModal')" class="text-blue-600 hover:underline font-bold">S'inscrire</button></p>
    </form>
</div></div>

<!-- REGISTER -->
<div id="registerModal" class="modal"><div class="modal-content">
    <div class="flex justify-between items-center mb-4"><h2 class="text-xl font-black">âœ¨ Inscription</h2><button onclick="closeModal('registerModal')" class="text-slate-400 hover:text-slate-600 text-2xl">&times;</button></div>
    <form onsubmit="handleRegister(event)" class="space-y-4">
        <div><label class="lbl">Type de compte *</label><div class="grid grid-cols-2 gap-3">
            <label class="cursor-pointer"><input type="radio" name="regRole" value="expediteur" checked class="peer sr-only" onchange="toggleRegFields()"><div class="p-3 border-2 border-slate-200 rounded-xl text-center peer-checked:border-blue-600 peer-checked:bg-blue-50 transition text-sm"><div class="text-xl mb-1">ğŸ“¦</div><div class="font-bold">ExpÃ©diteur</div></div></label>
            <label class="cursor-pointer"><input type="radio" name="regRole" value="transporteur" class="peer sr-only" onchange="toggleRegFields()"><div class="p-3 border-2 border-slate-200 rounded-xl text-center peer-checked:border-emerald-600 peer-checked:bg-emerald-50 transition text-sm"><div class="text-xl mb-1">ğŸš›</div><div class="font-bold">Transporteur</div></div></label>
        </div></div>
        <div class="grid grid-cols-2 gap-3"><div><label class="lbl">PrÃ©nom *</label><input type="text" name="prenom" required class="inp"></div><div><label class="lbl">Nom *</label><input type="text" name="nom" required class="inp"></div></div>
        <div><label class="lbl">Email *</label><input type="email" name="email" required class="inp"></div>
        <div><label class="lbl">TÃ©lÃ©phone</label><input type="tel" name="tel" class="inp"></div>
        <div id="regDeptField" class="hidden"><label class="lbl">DÃ©partement d'activitÃ© *</label><select name="departement" id="regDept" class="inp"></select></div>
        <div><label class="lbl">Mot de passe *</label><input type="password" name="password" required minlength="6" class="inp"><p class="text-xs text-slate-400 mt-1">Min. 6 caractÃ¨res</p></div>
        <button type="submit" class="w-full bg-gradient-to-r from-blue-600 to-cyan-600 text-white font-bold py-3.5 rounded-xl shadow-lg hover:scale-105 transition-all">CrÃ©er mon compte</button>
    </form>
</div></div>

<!-- CONFORMITY FORM (Transporteur) -->
<div id="conformityModal" class="modal"><div class="modal-content modal-lg">
    <div class="flex justify-between items-center mb-4"><h2 class="text-xl font-black">ğŸ“‹ Dossier de ConformitÃ© Transporteur</h2><button onclick="closeModal('conformityModal')" class="text-slate-400 hover:text-slate-600 text-2xl">&times;</button></div>
    <p class="text-sm text-slate-600 mb-6">Remplissez toutes les sections. Votre dossier sera examinÃ© par un administrateur.</p>
    <form onsubmit="submitConformity(event)" class="space-y-4">
        <div class="section-title">1ï¸âƒ£ IdentitÃ© & ConformitÃ© LÃ©gale</div>
        <div class="grid md:grid-cols-2 gap-3">
            <div><label class="lbl">NÂ° licence transport *</label><input type="text" id="cfLicence" required class="inp"></div>
            <div><label class="lbl">Date validitÃ© assurances (RC+Marchandises) *</label><input type="date" id="cfAssurDate" required class="inp"></div>
            <div><label class="lbl">Immatriculation tracteur *</label><input type="text" id="cfImmatTracteur" required class="inp"></div>
            <div><label class="lbl">Immatriculation remorque</label><input type="text" id="cfImmatRemorque" class="inp"></div>
        </div>
        <div class="check-row"><input type="checkbox" id="cfAssurOk" required><label for="cfAssurOk">Assurances valides (RC + Marchandises)</label></div>
        <div class="check-row"><input type="checkbox" id="cfVehicAge" required><label for="cfVehicAge">VÃ©hicule â‰¤ 10 ans ou entretien certifiÃ©</label></div>

        <div class="section-title">2ï¸âƒ£ Le Chauffeur</div>
        <div class="check-row"><input type="checkbox" id="cfPermis" required><label for="cfPermis">Permis valide catÃ©gorie adaptÃ©e</label></div>
        <div class="check-row"><input type="checkbox" id="cfCasier" required><label for="cfCasier">Casier judiciaire vierge (violences/vol)</label></div>
        <div class="check-row"><input type="checkbox" id="cfAlcool" required><label for="cfAlcool">Politique Alcool/Drogues signÃ©e</label></div>
        <div class="check-row"><input type="checkbox" id="cfBadge" required><label for="cfBadge">Badge d'identification professionnel</label></div>

        <div class="section-title">3ï¸âƒ£ SÃ©curitÃ© VÃ©hicule</div>
        <div class="check-row"><input type="checkbox" id="cfEtatPro" required><label for="cfEtatPro">Ã‰tat professionnel sans dÃ©gradation visible</label></div>
        <div class="check-row"><input type="checkbox" id="cfEquip" required><label for="cfEquip">Extincteur + triangles + gilet jaune</label></div>
        <div class="check-row"><input type="checkbox" id="cfVerrou" required><label for="cfVerrou">SystÃ¨me verrouillage cabine/coffres fonctionnel</label></div>
        <div class="check-row"><input type="checkbox" id="cfSangles" required><label for="cfSangles">Sangles d'arrimage suffisantes</label></div>

        <div class="section-title">4ï¸âƒ£ RÃ¨gles d'Or â€” Non NÃ©gociables</div>
        <div class="check-row"><input type="checkbox" id="cfSousTrait" required><label for="cfSousTrait">Je m'engage Ã  ne JAMAIS sous-traiter sans autorisation Ã©crite</label></div>
        <div class="check-row"><input type="checkbox" id="cfLoadBoard" required><label for="cfLoadBoard">Je n'utilise pas les "load boards" publics</label></div>
        <div class="check-row"><input type="checkbox" id="cfGps" required><label for="cfGps">GPS embarquÃ© actif temps rÃ©el</label></div>
        <div class="check-row"><input type="checkbox" id="cfHistorique" required><label for="cfHistorique">Historique positions conservÃ© 6 mois</label></div>
        <div><label class="lbl">NumÃ©ro tÃ©lÃ©phone joignable 24/7 *</label><input type="tel" id="cfTel247" required class="inp"></div>
        <div class="check-row"><input type="checkbox" id="cfDonnees" required><label for="cfDonnees">Je protÃ¨ge les infos clients (pas de partage rÃ©seaux sociaux)</label></div>

        <div class="section-title">5ï¸âƒ£ ProcÃ©dures de SÃ©curitÃ©</div>
        <div class="check-row"><input type="checkbox" id="cfInspection" required><label for="cfInspection">Inspection vÃ©hicule avant chaque chargement</label></div>
        <div class="check-row"><input type="checkbox" id="cfScellage" required><label for="cfScellage">ProcÃ©dure scellage connue (enregistrement nÂ° sur CMR)</label></div>
        <div class="check-row"><input type="checkbox" id="cfAlerte" required><label for="cfAlerte">ProcÃ©dure alerte en cas d'incident (arrÃªt non prÃ©vu)</label></div>

        <div class="section-title">6ï¸âƒ£ Documents Ã  Joindre</div>
        <div class="grid md:grid-cols-2 gap-3">
            <div><label class="lbl">K-BIS / Enregistrement commercial *</label><input type="file" id="cfDocKbis" accept=".pdf,.jpg,.png" required class="inp text-xs"></div>
            <div><label class="lbl">Assurance RC Pro *</label><input type="file" id="cfDocAssur" accept=".pdf,.jpg,.png" required class="inp text-xs"></div>
            <div><label class="lbl">Photo vÃ©hicule (profil) *</label><input type="file" id="cfDocPhoto" accept="image/*" required class="inp text-xs"></div>
            <div><label class="lbl">Copie permis de conduire *</label><input type="file" id="cfDocPermis" accept=".pdf,.jpg,.png" required class="inp text-xs"></div>
        </div>

        <div class="mt-4 p-4 bg-blue-50 border border-blue-200 rounded-xl text-sm text-blue-900">
            En soumettant ce formulaire, je certifie que toutes les informations fournies sont exactes et m'engage Ã  respecter les rÃ¨gles de WASL Transport.
        </div>
        <button type="submit" class="w-full py-4 bg-green-600 text-white rounded-xl font-bold hover:bg-green-700 text-lg">âœ… Soumettre mon dossier</button>
    </form>
</div></div>

<!-- DEMANDE TRANSPORT (formulaire complet) -->
<div id="demandeModal" class="modal"><div class="modal-content modal-xl">
    <div class="flex justify-between items-center mb-4"><h2 class="text-xl font-black">ğŸ“¦ Nouvelle demande de prise en charge</h2><button onclick="closeModal('demandeModal')" class="text-slate-400 hover:text-slate-600 text-2xl">&times;</button></div>
    <form onsubmit="handleDemande(event)">
        <div class="grid md:grid-cols-2 gap-6">
            <!-- LEFT: ExpÃ©diteur + Destinataire -->
            <div>
                <div class="section-title">ğŸ“¤ ExpÃ©diteur</div>
                <div class="space-y-2 mb-4">
                    <div><label class="lbl">Nom / SociÃ©tÃ©</label><input type="text" id="dExpNom" class="inp" readonly></div>
                    <div class="grid grid-cols-2 gap-2"><div><label class="lbl">TÃ©lÃ©phone</label><input type="text" id="dExpTel" class="inp"></div><div><label class="lbl">Email</label><input type="text" id="dExpEmail" class="inp" readonly></div></div>
                </div>
                <div class="section-title">ğŸ“¥ Destinataire</div>
                <div class="space-y-2">
                    <div class="grid grid-cols-3 gap-2"><div class="col-span-1"><label class="lbl">Code</label><input type="text" id="dDestCode" class="inp"></div><div class="col-span-2"><label class="lbl">Nom *</label><input type="text" id="dDestNom" required class="inp"></div></div>
                    <div><label class="lbl">Adresse *</label><input type="text" id="dDestAddr1" required class="inp" placeholder="Ligne 1"></div>
                    <div><input type="text" id="dDestAddr2" class="inp" placeholder="Ligne 2 (optionnel)"></div>
                    <div class="grid grid-cols-3 gap-2"><div><label class="lbl">Code postal *</label><input type="text" id="dDestCP" required class="inp"></div><div class="col-span-2"><label class="lbl">Ville *</label><input type="text" id="dDestVille" required class="inp"></div></div>
                    <div class="grid grid-cols-2 gap-2"><div><label class="lbl">RÃ©gion</label><input type="text" id="dDestRegion" class="inp"></div><div><label class="lbl">Pays</label><input type="text" id="dDestPays" value="FR" class="inp"></div></div>
                    <div class="grid grid-cols-2 gap-2"><div><label class="lbl">TÃ©lÃ©phone</label><input type="tel" id="dDestTel" class="inp"></div><div><label class="lbl">Email</label><input type="email" id="dDestEmail" class="inp"></div></div>
                    <div class="grid grid-cols-2 gap-2"><div><label class="lbl">Mot directeur</label><input type="text" id="dDestMotDir" class="inp"></div><div><label class="lbl">Contact</label><input type="text" id="dDestContact" class="inp"></div></div>
                    <div class="flex items-center gap-4 text-xs mt-1"><label class="flex items-center gap-1"><input type="radio" name="destType" value="save" checked>Enregistrer le destinataire</label><label class="flex items-center gap-1"><input type="radio" name="destType" value="temp">Temporaire</label></div>
                </div>
                <div class="section-title mt-4">ğŸ“ EnlÃ¨vement</div>
                <div class="space-y-2">
                    <div class="grid grid-cols-3 gap-2"><div><label class="lbl">Ville dÃ©part *</label><input type="text" id="dFromCity" required class="inp" placeholder="Ex: Bayonne"></div><div class="col-span-2"><label class="lbl">Adresse dÃ©part *</label><input type="text" id="dFromAddr" required class="inp"></div></div>
                    <div class="grid grid-cols-2 gap-2"><div><label class="lbl">Date d'enlÃ¨vement *</label><input type="date" id="dDate" required class="inp"></div><div><label class="lbl">Type transport *</label><select id="dType" class="inp"><option value="routier">ğŸš› Routier</option><option value="aerien">âœˆï¸ AÃ©rien</option></select></div></div>
                </div>
            </div>
            <!-- RIGHT: Colisage + Instructions -->
            <div>
                <div class="section-title">ğŸ“¦ Colisage</div>
                <div class="space-y-2">
                    <div class="grid grid-cols-2 gap-2"><div><label class="lbl">NÂ° de B.L.</label><input type="text" id="dNumBL" class="inp"></div><div><label class="lbl">RÃ©f. destinataire</label><input type="text" id="dRefDest" class="inp"></div></div>
                    <div class="grid grid-cols-3 gap-2"><div><label class="lbl">UM (unitÃ©s) *</label><input type="number" id="dUM" required min="0" value="0" class="inp"></div><div><label class="lbl">Dont consignÃ©es</label><input type="number" id="dConsignees" min="0" value="0" class="inp"></div><div><label class="lbl">Poids (kg) *</label><input type="number" id="dPoids" required step="0.1" min="0" value="0" class="inp"></div></div>
                    <div class="grid grid-cols-2 gap-2"><div><label class="lbl">Longueur (m)</label><input type="number" id="dLongueur" step="0.01" min="0" value="0" class="inp"></div><div><label class="lbl">Volume (mÂ³)</label><input type="number" id="dVolume" step="0.01" min="0" value="0" class="inp"></div></div>
                    <div><label class="lbl">Nature marchandise *</label><input type="text" id="dNature" required class="inp" placeholder="Ex: Palettes textiles"></div>
                    <div class="grid grid-cols-2 gap-2"><div><label class="lbl">Valeur dÃ©clarÃ©e</label><input type="number" id="dValeur" step="0.01" min="0" value="0" class="inp"></div><div><label class="lbl">Devise</label><select id="dDevise" class="inp"><option value="EUR">EUR (Euro)</option><option value="USD">USD (Dollar)</option><option value="GBP">GBP (Livre)</option></select></div></div>
                </div>
                <div class="section-title mt-4">ğŸ“ Instructions</div>
                <div class="space-y-2">
                    <div><label class="lbl">Instructions</label><textarea id="dInstructions" rows="3" class="inp resize-none" placeholder="Fragile, tempÃ©rature dirigÃ©e..."></textarea></div>
                    <div><label class="lbl">Remarques</label><textarea id="dRemarques" rows="2" class="inp resize-none"></textarea></div>
                </div>
                <button type="submit" class="w-full mt-6 py-4 bg-green-600 text-white rounded-xl font-bold hover:bg-green-700 text-lg">âœ… Soumettre la demande</button>
            </div>
        </div>
    </form>
</div></div>

<!-- DEVIS (ExpÃ©diteur) -->
<div id="devisModal" class="modal"><div class="modal-content modal-lg">
    <div class="flex justify-between items-center mb-4"><h2 class="text-xl font-black">ğŸ’° Propositions</h2><button onclick="closeModal('devisModal')" class="text-slate-400 hover:text-slate-600 text-2xl">&times;</button></div>
    <p class="text-slate-600 mb-4 text-sm" id="devisSub"></p>
    <div id="devisCards" class="grid md:grid-cols-3 gap-4"></div>
</div></div>

<!-- OFFER (Transporteur) -->
<div id="offerModal" class="modal"><div class="modal-content">
    <div class="flex justify-between items-center mb-4"><h2 class="text-xl font-black">ğŸ“ Soumettre une offre</h2><button onclick="closeModal('offerModal')" class="text-slate-400 hover:text-slate-600 text-2xl">&times;</button></div>
    <div class="mb-4 p-3 bg-blue-50 rounded-xl text-sm" id="offerInfo"></div>
    <form onsubmit="submitOffer(event)" class="space-y-3">
        <div><label class="lbl">Prix proposÃ© (â‚¬ HT) *</label><input type="number" id="ofPrix" required step="0.01" min="1" class="inp"></div>
        <div class="grid grid-cols-2 gap-3"><div><label class="lbl">Date prise en charge *</label><input type="date" id="ofDatePEC" required class="inp"></div><div><label class="lbl">Heure *</label><input type="time" id="ofHeurePEC" required class="inp"></div></div>
        <div class="grid grid-cols-2 gap-3"><div><label class="lbl">Date livraison estimÃ©e *</label><input type="date" id="ofDateLiv" required class="inp"></div><div><label class="lbl">Heure *</label><input type="time" id="ofHeureLiv" required class="inp"></div></div>
        <div><label class="lbl">Chauffeur assignÃ©</label><select id="ofChauffeur" class="inp"><option value="">â€” Moi-mÃªme â€”</option></select></div>
        <button type="submit" class="w-full py-3 bg-green-600 text-white rounded-xl font-bold">âœ… Envoyer</button>
    </form>
</div></div>

<!-- COMPOSE DEVIS (Admin) -->
<div id="composeModal" class="modal"><div class="modal-content modal-lg">
    <div class="flex justify-between items-center mb-4"><h2 class="text-xl font-black">ğŸ“¨ Devis client</h2><button onclick="closeModal('composeModal')" class="text-slate-400 hover:text-slate-600 text-2xl">&times;</button></div>
    <div class="mb-3 p-3 bg-slate-50 rounded-xl text-sm" id="composeInfo"></div>
    <div class="mb-3" id="composeOffres"></div>
    <h3 class="font-bold text-sm mb-2">Propositions (1 Ã  3) :</h3>
    <div id="composeFields" class="space-y-2 mb-3"></div>
    <button onclick="addDevisRow()" id="addDevisBtn" class="text-blue-600 font-bold text-xs mb-4 hover:underline">+ Ajouter</button>
    <button onclick="sendDevis()" class="w-full py-3 bg-blue-600 text-white rounded-xl font-bold">ğŸ“¨ Envoyer au client</button>
</div></div>

<!-- UPLOAD PROOF -->
<div id="uploadModal" class="modal"><div class="modal-content">
    <div class="flex justify-between items-center mb-4"><h2 class="text-xl font-black">ğŸ“· Preuve de livraison</h2><button onclick="closeModal('uploadModal')" class="text-slate-400 hover:text-slate-600 text-2xl">&times;</button></div>
    <div id="uploadS1"><div class="mb-3"><div class="p-3 bg-slate-100 rounded-xl font-bold text-sm" id="uploadRef"></div></div>
        <div class="mb-3"><label class="lbl">Photo(s) *</label><div class="border-2 border-dashed border-slate-300 rounded-xl p-6 text-center hover:border-blue-500 transition cursor-pointer" onclick="document.getElementById('photoInput').click()"><input type="file" id="photoInput" accept="image/*" multiple class="hidden" onchange="previewPhotos(event)"><div class="text-3xl mb-1">ğŸ“·</div><p class="text-slate-600 text-sm">Cliquez pour ajouter</p></div><div id="photoPreview" class="grid grid-cols-3 gap-2 mt-3"></div></div>
        <div class="mb-3"><label class="lbl">Signataire</label><input type="text" id="signataire" class="inp"></div>
        <button onclick="submitDelivery()" class="w-full py-3 bg-green-600 text-white rounded-xl font-bold">Soumettre</button>
    </div>
    <div id="uploadS2" class="hidden text-center py-8"><div class="text-5xl mb-3">â³</div><h3 class="font-bold text-lg">Livraison soumise !</h3><p class="text-slate-600 text-sm mb-4">En attente de validation admin.</p><button onclick="closeModal('uploadModal')" class="px-6 py-2 bg-blue-600 text-white rounded-xl font-bold">Fermer</button></div>
</div></div>

<!-- REJECT -->
<div id="rejectModal" class="modal"><div class="modal-content">
    <div class="flex justify-between items-center mb-4"><h2 class="text-xl font-black">âŒ Rejeter</h2><button onclick="closeModal('rejectModal')" class="text-slate-400 hover:text-slate-600 text-2xl">&times;</button></div>
    <div class="mb-3"><label class="lbl">Motif *</label><textarea id="rejectMotif" rows="3" class="inp resize-none" required placeholder="DÃ©crivez le problÃ¨me..."></textarea></div>
    <button onclick="confirmReject()" class="w-full py-3 bg-red-600 text-white rounded-xl font-bold">Confirmer le rejet</button>
</div></div>

<!-- ADD CHAUFFEUR -->
<div id="chauffeurModal" class="modal"><div class="modal-content">
    <div class="flex justify-between items-center mb-4"><h2 class="text-xl font-black">ğŸ‘¤ Ajouter un chauffeur</h2><button onclick="closeModal('chauffeurModal')" class="text-slate-400 hover:text-slate-600 text-2xl">&times;</button></div>
    <form onsubmit="addChauffeur(event)" class="space-y-3">
        <div class="grid grid-cols-2 gap-3"><div><label class="lbl">PrÃ©nom *</label><input type="text" id="chPrenom" required class="inp"></div><div><label class="lbl">Nom *</label><input type="text" id="chNom" required class="inp"></div></div>
        <div><label class="lbl">NÂ° Permis *</label><input type="text" id="chPermis" required class="inp"></div>
        <div class="grid grid-cols-2 gap-3"><div><label class="lbl">CatÃ©gorie</label><input type="text" id="chCategorie" class="inp" value="CE"></div><div><label class="lbl">ValiditÃ© permis</label><input type="date" id="chValidite" class="inp"></div></div>
        <div><label class="lbl">TÃ©lÃ©phone</label><input type="tel" id="chTel" class="inp"></div>
        <button type="submit" class="w-full py-3 bg-green-600 text-white rounded-xl font-bold">âœ… Ajouter</button>
    </form>
</div></div>

<!-- DOC VIEWER -->
<div id="docModal" class="modal"><div class="modal-content modal-xxl">
    <div class="flex justify-between items-center mb-4 no-print"><h2 class="text-xl font-black">Document</h2><div class="flex gap-2"><button onclick="window.print()" class="px-3 py-1.5 bg-slate-800 text-white rounded-lg text-sm font-bold">ğŸ–¨ï¸ Imprimer</button><button onclick="closeModal('docModal')" class="text-slate-400 hover:text-slate-600 text-2xl">&times;</button></div></div>
    <div id="docContent"></div>
</div></div>

<!-- ADMIN ROLE EDITOR -->
<div id="roleModal" class="modal"><div class="modal-content">
    <div class="flex justify-between items-center mb-4"><h2 class="text-xl font-black">âš™ï¸ GÃ©rer les rÃ´les</h2><button onclick="closeModal('roleModal')" class="text-slate-400 hover:text-slate-600 text-2xl">&times;</button></div>
    <div id="roleUserInfo" class="mb-4 p-3 bg-slate-50 rounded-xl text-sm"></div>
    <div id="roleCheckboxes" class="space-y-3 mb-4"></div>
    <button onclick="saveRoles()" class="w-full py-3 bg-blue-600 text-white rounded-xl font-bold">ğŸ’¾ Enregistrer</button>
</div></div>

<!-- ==================== JAVASCRIPT ==================== -->
<script>
let CU=null,activeRole='',expFilt='all',expPg=1;const PP=5;
let curOfferRef=null,curUploadRef=null,curRejectRef=null,curComposeRef=null,devisCnt=0,curRoleUserId=null;
window.aUserFilter='all';
const DN={'01':'Ain','02':'Aisne','03':'Allier','04':'Alpes-Hte-Provence','05':'Hautes-Alpes','06':'Alpes-Maritimes','07':'ArdÃ¨che','08':'Ardennes','09':'AriÃ¨ge','10':'Aube','11':'Aude','12':'Aveyron','13':'Bouches-du-RhÃ´ne','14':'Calvados','15':'Cantal','16':'Charente','17':'Charente-Maritime','18':'Cher','19':'CorrÃ¨ze','2A':'Corse-du-Sud','2B':'Haute-Corse','21':"CÃ´te-d'Or",'22':"CÃ´tes-d'Armor",'23':'Creuse','24':'Dordogne','25':'Doubs','26':'DrÃ´me','27':'Eure','28':'Eure-et-Loir','29':'FinistÃ¨re','30':'Gard','31':'Haute-Garonne','32':'Gers','33':'Gironde','34':'HÃ©rault','35':'Ille-et-Vilaine','36':'Indre','37':'Indre-et-Loire','38':'IsÃ¨re','39':'Jura','40':'Landes','41':'Loir-et-Cher','42':'Loire','43':'Haute-Loire','44':'Loire-Atlantique','45':'Loiret','46':'Lot','47':'Lot-et-Garonne','48':'LozÃ¨re','49':'Maine-et-Loire','50':'Manche','51':'Marne','52':'Haute-Marne','53':'Mayenne','54':'Meurthe-et-Moselle','55':'Meuse','56':'Morbihan','57':'Moselle','58':'NiÃ¨vre','59':'Nord','60':'Oise','61':'Orne','62':'Pas-de-Calais','63':'Puy-de-DÃ´me','64':'PyrÃ©nÃ©es-Atlantiques','65':'Hautes-PyrÃ©nÃ©es','66':'PyrÃ©nÃ©es-Orientales','67':'Bas-Rhin','68':'Haut-Rhin','69':'RhÃ´ne','70':'Haute-SaÃ´ne','71':'SaÃ´ne-et-Loire','72':'Sarthe','73':'Savoie','74':'Haute-Savoie','75':'Paris','76':'Seine-Maritime','77':'Seine-et-Marne','78':'Yvelines','79':'Deux-SÃ¨vres','80':'Somme','81':'Tarn','82':'Tarn-et-Garonne','83':'Var','84':'Vaucluse','85':'VendÃ©e','86':'Vienne','87':'Haute-Vienne','88':'Vosges','89':'Yonne','90':'Territoire de Belfort','91':'Essonne','92':'Hauts-de-Seine','93':'Seine-Saint-Denis','94':'Val-de-Marne','95':"Val-d'Oise"};
const DA={'01':['38','39','69','71','73','74'],'02':['08','51','59','60','77','80'],'03':['18','23','42','58','63'],'04':['05','06','26','83','84'],'05':['04','26','38','73'],'06':['04','83'],'07':['26','30','38','42','43','48'],'08':['02','51','55'],'09':['11','31','66'],'10':['21','51','52','77','89'],'11':['09','31','34','66','81'],'12':['15','30','34','46','48','81','82'],'13':['30','83','84'],'14':['27','50','61','76'],'15':['12','19','43','46','63'],'16':['17','24','79','86','87'],'17':['16','24','33','79','85'],'18':['03','23','36','41','45','58'],'19':['15','23','24','46','63','87'],'2A':['2B'],'2B':['2A'],'21':['10','39','52','58','70','71','89'],'22':['29','35','56'],'23':['03','18','19','36','63','87'],'24':['16','17','19','33','46','47','87'],'25':['39','70','90'],'26':['04','05','07','38','84'],'27':['14','28','60','76','78','95'],'28':['27','41','45','61','72','78','91'],'29':['22','56'],'30':['07','12','13','34','48','84'],'31':['09','11','32','65','81','82'],'32':['31','40','47','64','65','82'],'33':['17','24','40','47'],'34':['11','12','30','81'],'35':['22','44','49','50','53','56'],'36':['18','23','37','41','86','87'],'37':['36','41','49','72','86'],'38':['01','05','07','26','42','69','73'],'39':['01','21','25','70','71'],'40':['32','33','47','64'],'41':['18','28','36','37','45','72'],'42':['03','07','38','43','63','69'],'43':['07','15','42','48','63'],'44':['35','49','56','85'],'45':['18','28','41','58','77','89','91'],'46':['12','15','19','24','47','82'],'47':['24','32','33','40','46','82'],'48':['07','12','15','30','43'],'49':['35','37','44','53','72','79','85','86'],'50':['14','35','53','61'],'51':['02','08','10','52','55','77'],'52':['10','21','51','54','55','70','88'],'53':['35','49','50','61','72'],'54':['55','57','67','88'],'55':['08','51','52','54','88'],'56':['22','29','35','44'],'57':['54','67'],'58':['03','18','21','45','71','89'],'59':['02','62','80'],'60':['02','27','76','77','78','80','95'],'61':['14','27','28','50','53','72','76'],'62':['59','80'],'63':['03','15','19','23','42','43'],'64':['32','40','65'],'65':['31','32','64'],'66':['09','11'],'67':['54','57','68'],'68':['67','88','90'],'69':['01','38','42','71'],'70':['21','25','39','52','88','90'],'71':['01','21','39','42','58','69'],'72':['28','37','41','49','53','61'],'73':['01','05','38','74'],'74':['01','73'],'75':['92','93','94'],'76':['14','27','60','61','80'],'77':['02','10','45','51','60','89','91','93','94'],'78':['27','28','60','91','92','95'],'79':['16','17','49','85','86'],'80':['02','59','60','62','76'],'81':['11','12','31','34','82'],'82':['12','31','32','46','47','81'],'83':['04','06','13','84'],'84':['04','13','26','30','83'],'85':['17','44','49','79'],'86':['16','36','37','49','79','87'],'87':['16','19','23','24','36','86'],'88':['52','54','55','67','68','70'],'89':['10','21','45','58','77'],'90':['25','68','70'],'91':['28','45','77','78','92','94'],'92':['75','78','91','93','94','95'],'93':['75','77','92','94','95'],'94':['75','77','91','92','93'],'95':['27','60','78','92','93']};
const CD={'paris':'75','lyon':'69','marseille':'13','nice':'06','toulouse':'31','bordeaux':'33','bayonne':'64','pau':'64','biarritz':'64','lille':'59','strasbourg':'67','nantes':'44','montpellier':'34','rennes':'35','saint-etienne':'42','toulon':'83','grenoble':'38','dijon':'21','angers':'49','nimes':'30','clermont-ferrand':'63','le havre':'76','reims':'51','brest':'29','limoges':'87','tours':'37','amiens':'80','perpignan':'66','metz':'57','besancon':'25','orleans':'45','rouen':'76','caen':'14','nancy':'54','avignon':'84','poitiers':'86','la rochelle':'17','colmar':'68','tarbes':'65','dax':'40','mont-de-marsan':'40','auch':'32','lourdes':'65','hendaye':'64','saint-jean-de-luz':'64','anglet':'64'};
function getDept(c){return c?CD[c.toLowerCase().trim()]||null:null;}
function eligDepts(d){return d?[d,...(DA[d]||[])]:[];}
const US={};
function gU(){return Object.values(US);}
function gT(){return gU().filter(u=>(u.roles||[]).includes('transporteur')&&u.transStatus==='validated');}
function gM(){return JSON.parse(localStorage.getItem('w_m')||'[]');}
function sM(m){localStorage.setItem('w_m',JSON.stringify(m));}
function gC(tid){return JSON.parse(localStorage.getItem('w_ch_'+tid)||'[]');}
function sC(tid,c){localStorage.setItem('w_ch_'+tid,JSON.stringify(c));}
function saveUser(u){US[u.email]=u;const s=JSON.parse(localStorage.getItem('w_us')||'[]');const i=s.findIndex(x=>x.email===u.email);if(i>=0)s[i]=u;else s.push(u);localStorage.setItem('w_us',JSON.stringify(s));}
function initData(){
[{id:1,email:'expediteur@wasl.fr',password:'demo123',prenom:'Jean',nom:'Dupont',tel:'0601020304',roles:['expediteur'],departement:null,transStatus:null,conformity:null},{id:2,email:'transporteur@wasl.fr',password:'demo123',prenom:'Marie',nom:'Martin',tel:'0605060708',roles:['transporteur'],departement:'75',transStatus:'validated',conformity:{licence:'LT-2024-001',immatTracteur:'AB-123-CD',tel247:'0605060708'}},{id:3,email:'admin@wasl.fr',password:'admin123',prenom:'Admin',nom:'WASL',tel:'',roles:['admin'],departement:null,transStatus:null,conformity:null},{id:4,email:'transporteur2@wasl.fr',password:'demo123',prenom:'Pierre',nom:'Durand',tel:'0611223344',roles:['transporteur'],departement:'64',transStatus:'validated',conformity:{licence:'LT-2024-064',immatTracteur:'EF-456-GH',tel247:'0611223344'}}].forEach(u=>US[u.email]=u);
(JSON.parse(localStorage.getItem('w_us')||'[]')).forEach(u=>US[u.email]=u);
if(!localStorage.getItem('w_m')){sM([
{ref:'WASL-001',expediteurId:1,expediteurNom:'Jean Dupont',type:'routier',fromCity:'Paris',fromAddr:'12 Rue de la Paix',dest:{nom:'Entreprise Nice',addr1:'45 Ave Jean MÃ©decin',cp:'06000',ville:'Nice',pays:'FR'},departement:'75',nature:'Mobilier de bureau',um:3,poids:150,longueur:2,volume:4,valeur:5000,devise:'EUR',numBL:'BL-001',date:'2025-01-15',instructions:'',remarques:'',status:'progress',offres:[{tId:2,nom:'Marie Martin',dept:'75',prix:300,datePEC:'2025-01-15',heurePEC:'08:00',dateLiv:'2025-01-17',heureLiv:'14:00',dateO:new Date().toISOString()}],devis:[],devisChoisi:null,transporteurId:2,transporteurNom:'Marie Martin',prixT:300,prixC:420,livraison:null,rejetMotif:null,factureEmise:false},
{ref:'WASL-002',expediteurId:1,expediteurNom:'Jean Dupont',type:'aerien',fromCity:'Bayonne',fromAddr:'8 Bd Haussmann',dest:{nom:'Client Bruxelles',addr1:'22 Avenue Louise',cp:'1050',ville:'Bruxelles',pays:'BE'},departement:'64',nature:'Documents confidentiels',um:1,poids:5,longueur:0.5,volume:0.1,valeur:1000,devise:'EUR',numBL:'BL-002',date:'2025-01-20',instructions:'Fragile',remarques:'',status:'pending',offres:[],devis:[],devisChoisi:null,transporteurId:null,transporteurNom:null,prixT:null,prixC:null,livraison:null,rejetMotif:null,factureEmise:false}
]);}
}
function sL(s){return{pending:'En attente',quoted:'Devis envoyÃ©',accepted:'AcceptÃ©',progress:'En cours',pending_delivery:'Livr. soumise',delivered:'LivrÃ©e'}[s]||s;}
function sPct(s){return{pending:10,quoted:25,accepted:40,progress:60,pending_delivery:85,delivered:100}[s]||0;}
function sCol(s){return{pending:'yellow',quoted:'indigo',accepted:'blue',progress:'blue',pending_delivery:'orange',delivered:'green'}[s]||'slate';}
function fillLogin(e,p){document.getElementById('loginEmail').value=e;document.getElementById('loginPwd').value=p;}
function handleLogin(e){e.preventDefault();const em=document.getElementById('loginEmail').value,pw=document.getElementById('loginPwd').value,u=US[em];if(u&&u.password===pw){CU=u;const r=u.roles||[];activeRole=r.includes('admin')?'admin':r.includes('expediteur')?'expediteur':r.includes('transporteur')?'transporteur':'';if(!activeRole){alert('Aucun rÃ´le');return;}localStorage.setItem('w_cu',JSON.stringify(u));closeModal('loginModal');showNav();showDash();}else alert('Identifiants incorrects');}
function handleRegister(e){e.preventDefault();const f=e.target,role=f.regRole.value;const u={id:Date.now(),prenom:f.prenom.value,nom:f.nom.value,email:f.email.value,tel:f.tel?.value||'',roles:[role],departement:role==='transporteur'?f.departement.value:null,transStatus:role==='transporteur'?'pending_validation':null,conformity:null,password:f.password.value};if(US[u.email]){alert('Email dÃ©jÃ  utilisÃ©');return;}saveUser(u);CU=u;activeRole=role;localStorage.setItem('w_cu',JSON.stringify(u));closeModal('registerModal');showNav();showDash();}
function toggleRegFields(){document.getElementById('regDeptField').classList.toggle('hidden',document.querySelector('input[name="regRole"]:checked').value!=='transporteur');}
function logout(){localStorage.removeItem('w_cu');CU=null;location.reload();}
function showNav(){document.getElementById('navPublic').classList.add('hidden');document.getElementById('navConnected').classList.remove('hidden');document.getElementById('heroSection').classList.add('hidden');document.getElementById('navBrand').className='text-2xl font-black text-slate-900';document.getElementById('userName').textContent=CU.prenom+' '+CU.nom;updateRoleBadge();const r=CU.roles||[],sw=document.getElementById('roleSwitcher');if(r.includes('expediteur')&&r.includes('transporteur')){sw.classList.remove('hidden');sw.classList.add('flex');updateSwitcher();}else sw.classList.add('hidden');}
function updateRoleBadge(){const b=document.getElementById('userRole');if(activeRole==='admin'){b.textContent='Admin';b.className='role-badge bg-purple-100 text-purple-700';}else if(activeRole==='transporteur'){b.textContent='Transporteur';b.className='role-badge role-trans';}else{b.textContent='ExpÃ©diteur';b.className='role-badge role-exp';}}
function updateSwitcher(){document.getElementById('rsExp').className='px-3 py-1.5 rounded-lg text-xs font-bold transition '+(activeRole==='expediteur'?'bg-blue-600 text-white':'text-slate-600');document.getElementById('rsTrans').className='px-3 py-1.5 rounded-lg text-xs font-bold transition '+(activeRole==='transporteur'?'bg-emerald-600 text-white':'text-slate-600');}
function switchActiveRole(r){activeRole=r;updateRoleBadge();updateSwitcher();showDash();}
function showDash(){document.querySelectorAll('.dashboard-section').forEach(s=>s.classList.remove('active'));if(activeRole==='expediteur'){document.getElementById('dashboardExp').classList.add('active');loadExp();}else if(activeRole==='transporteur'){document.getElementById('dashboardTrans').classList.add('active');loadTrans();}else if(activeRole==='admin'){document.getElementById('dashboardAdmin').classList.add('active');loadAdmin();}}
// === EXPÃ‰DITEUR ===
function showExpTab(t){document.getElementById('expTabExpContent').classList.toggle('hidden',t!=='expeditions');document.getElementById('expTabDocsContent').classList.toggle('hidden',t!=='documents');document.getElementById('expTabExp').classList.toggle('active',t==='expeditions');document.getElementById('expTabDocs').classList.toggle('active',t==='documents');if(t==='documents')renderExpDocs();}
function loadExp(){const ms=gM().filter(m=>m.expediteurId===CU?.id);const ct=s=>ms.filter(m=>s==='progress'?['accepted','progress'].includes(m.status):m.status===s).length;document.getElementById('expStats').innerHTML=[{f:'all',v:ms.length,l:'Total',c:'slate'},{f:'pending',v:ct('pending'),l:'Attente',c:'yellow'},{f:'quoted',v:ct('quoted'),l:'Devis',c:'indigo'},{f:'progress',v:ct('progress'),l:'En cours',c:'blue'},{f:'pending_delivery',v:ct('pending_delivery'),l:'Livr.',c:'orange'},{f:'delivered',v:ct('delivered'),l:'LivrÃ©es',c:'green'}].map(s=>`<div class="kpi-card cursor-pointer hover:border-${s.c}-300" onclick="filterExp('${s.f}')"><div class="kpi-val text-${s.c}-600">${s.v}</div><div class="kpi-lbl">${s.l}</div></div>`).join('');document.getElementById('expFilterBtns').innerHTML=[{f:'all',l:'Toutes'},{f:'pending',l:'â³'},{f:'quoted',l:'ğŸ’°'},{f:'progress',l:'ğŸš›'},{f:'delivered',l:'âœ…'}].map(b=>`<button onclick="filterExp('${b.f}')" class="px-3 py-1.5 rounded-lg text-xs font-bold ${expFilt===b.f?'bg-blue-600 text-white':'bg-slate-100 text-slate-600'}">${b.l}</button>`).join('');renderExpList();}
function filterExp(f){expFilt=f;expPg=1;loadExp();}
function renderExpList(){let ms=gM().filter(m=>m.expediteurId===CU?.id);if(expFilt!=='all')ms=ms.filter(m=>expFilt==='progress'?['accepted','progress'].includes(m.status):m.status===expFilt);const q=(document.getElementById('expSearch')?.value||'').toLowerCase();if(q)ms=ms.filter(m=>m.ref.toLowerCase().includes(q)||m.fromCity.toLowerCase().includes(q)||(m.dest?.ville||'').toLowerCase().includes(q)||m.nature.toLowerCase().includes(q));ms.sort((a,b)=>b.ref>a.ref?1:-1);const c=document.getElementById('expList'),pg=document.getElementById('expPag');if(!ms.length){c.innerHTML='<div class="p-8 text-center text-slate-400 text-sm">Aucune expÃ©dition</div>';pg.classList.add('hidden');return;}const tp=Math.ceil(ms.length/PP);if(expPg>tp)expPg=tp;
c.innerHTML=ms.slice((expPg-1)*PP,expPg*PP).map(m=>{const col=sCol(m.status),pct=sPct(m.status);return`<div class="p-4 hover:bg-slate-50"><div class="flex items-center justify-between cursor-pointer" onclick="this.nextElementSibling?.nextElementSibling?.nextElementSibling?.classList.toggle('hidden')"><div><div class="flex items-center gap-2 flex-wrap"><span class="font-black text-sm">${m.ref}</span><span class="status-${m.status} px-2 py-0.5 rounded-full text-xs font-bold">${sL(m.status)}</span></div><div class="text-xs text-slate-500">${m.fromCity} â†’ ${m.dest?.ville||'?'} â€¢ ${m.type==='aerien'?'âœˆï¸':'ğŸš›'}</div></div><div class="text-right"><div class="font-black text-${col}-600 text-sm">${m.prixC?m.prixC+' â‚¬':'â€”'}</div><div class="text-xs text-slate-400">${m.poids}kg</div></div></div><div class="mt-1"><div class="w-full h-1.5 bg-slate-100 rounded-full"><div class="h-full rounded-full bg-${col}-500" style="width:${pct}%"></div></div></div>${m.status==='quoted'?`<div class="mt-2 p-2 bg-indigo-50 border border-indigo-200 rounded-lg flex items-center justify-between"><span class="text-indigo-900 font-bold text-xs">ğŸ’° ${m.devis.length} proposition(s)</span><button onclick="event.stopPropagation();showDevis('${m.ref}')" class="px-3 py-1 bg-indigo-600 text-white rounded-lg text-xs font-bold">Voir</button></div>`:''}<div class="hidden mt-3 pt-3 border-t border-slate-100 text-sm"><div class="grid md:grid-cols-2 gap-2 mb-2"><div class="p-2 bg-white border rounded-lg text-xs"><strong>ğŸ“¤</strong> ${m.fromCity} â€” ${m.fromAddr}<br>ğŸ“… ${m.date}</div><div class="p-2 bg-white border rounded-lg text-xs"><strong>ğŸ“¥</strong> ${m.dest?.nom||'?'}<br>${m.dest?.addr1||''}, ${m.dest?.cp||''} ${m.dest?.ville||''}</div></div><div class="p-2 bg-slate-50 rounded-lg mb-2 text-xs">${m.nature} â€¢ ${m.poids}kg â€¢ ${m.um} UM${m.instructions?' â€¢ <em>'+m.instructions+'</em>':''}</div><div class="flex gap-1">${m.status==='pending'?`<button onclick="genDeclValeur('${m.ref}')" class="px-2 py-1 bg-cyan-600 text-white rounded text-xs font-bold">ğŸ’ DÃ©cl. valeur</button>`:''}${m.status==='delivered'?`<button onclick="viewPhotos('${m.ref}')" class="px-2 py-1 bg-blue-600 text-white rounded text-xs font-bold">ğŸ“·</button>`:''}</div></div></div>`;}).join('');
if(tp>1){pg.classList.remove('hidden');document.getElementById('expPagInfo').textContent=expPg+'/'+tp;document.getElementById('expPrev').disabled=expPg<=1;document.getElementById('expNext').disabled=expPg>=tp;}else pg.classList.add('hidden');}
function renderExpDocs(){const ms=gM().filter(m=>m.expediteurId===CU?.id),c=document.getElementById('expDocsList');if(!ms.length){c.innerHTML='<div class="p-6 text-center text-slate-400 text-sm">Aucune</div>';return;}c.innerHTML='<table class="w-full text-xs"><thead><tr class="bg-slate-50"><th class="p-3 text-left">RÃ©f</th><th class="p-3 text-left">Trajet</th><th class="p-3 text-center">Preuve</th><th class="p-3 text-center">Facture</th><th class="p-3 text-center">Actions</th></tr></thead><tbody>'+ms.map(m=>{const hp=m.livraison,ps=m.status==='delivered'&&hp?'âœ…':m.status==='pending_delivery'&&hp?'â³':'âŒ',is=m.factureEmise?'âœ…':'âŒ';return'<tr class="border-t hover:bg-slate-50"><td class="p-3 font-bold">'+m.ref+'</td><td class="p-3">'+m.fromCity+'â†’'+(m.dest?.ville||'?')+'</td><td class="p-3 text-center">'+ps+(m.status==='delivered'&&hp?' <button onclick="viewPhotos(\''+m.ref+'\')" class="text-blue-600 underline">voir</button>':'')+'</td><td class="p-3 text-center">'+is+(m.factureEmise?' <button onclick="viewInvoiceClient(\''+m.ref+'\')" class="text-blue-600 underline">voir</button>':'')+'</td><td class="p-3 text-center">'+(m.status==='pending'?'<button onclick="genDeclValeur(\''+m.ref+'\')" class="px-2 py-1 bg-cyan-600 text-white rounded text-xs font-bold">DÃ©cl.</button>':'-')+'</td></tr>';}).join('')+'</tbody></table>';}
function showDevis(ref){const m=gM().find(x=>x.ref===ref);if(!m)return;document.getElementById('devisSub').textContent=m.ref+' â€” '+m.fromCity+' â†’ '+(m.dest?.ville||'?');document.getElementById('devisCards').innerHTML=m.devis.map((d,i)=>'<div class="devis-card text-center" onclick="acceptDevis(\''+ref+'\','+i+')"><div class="text-2xl mb-2">'+['â­','ğŸš€','ğŸ’¼'][i]+'</div><div class="text-2xl font-black text-blue-600 mb-1">'+d.prixC+' â‚¬ <span class="text-xs text-slate-500">HT</span></div><div class="text-slate-600 text-sm mb-3">DÃ©lai: <strong>'+d.delai+'</strong></div><button class="w-full py-2 bg-blue-600 text-white rounded-xl font-bold text-sm">Choisir</button></div>').join('');openModal('devisModal');}
function acceptDevis(ref,i){const ms=gM(),m=ms.find(x=>x.ref===ref);m.devisChoisi=i;m.status='accepted';m.prixC=m.devis[i].prixC;sM(ms);closeModal('devisModal');loadExp();alert('âœ… Devis acceptÃ© !');}
// === TRANSPORTEUR ===
function showTransTab(t){const map={available:'Avail',my:'My',tms:'Tms',chauffeurs:'Chauf',comptabilite:'Compta'};Object.values(map).forEach(x=>{const el=document.getElementById('t'+x+'C');if(el)el.classList.add('hidden');});document.querySelectorAll('[id^="tTab"]').forEach(b=>b.classList.remove('active'));const k=map[t];if(document.getElementById('t'+k+'C'))document.getElementById('t'+k+'C').classList.remove('hidden');const caps={'Avail':'Avail','My':'My','Tms':'Tms','Chauf':'Chauf','Compta':'Compta'};const tabEl=document.getElementById('tTab'+k);if(tabEl)tabEl.classList.add('active');if(t==='tms')renderTMS();if(t==='chauffeurs')renderChauffeurs();if(t==='comptabilite')renderCompta();}
function loadTrans(){if(!CU)return;const isPending=CU.transStatus==='pending_validation'||CU.transStatus==='submitted';document.getElementById('transPendingBanner').classList.toggle('hidden',!isPending);document.getElementById('transActiveContent').classList.toggle('hidden',isPending);if(isPending)return;
const ms=gM(),dept=CU.departement,elig=eligDepts(dept),my=ms.filter(m=>m.transporteurId===CU.id);
document.getElementById('transStats').innerHTML=[{v:my.length,l:'Missions',c:'emerald'},{v:my.filter(m=>['progress','pending_delivery'].includes(m.status)).length,l:'En cours',c:'blue'},{v:my.filter(m=>m.status==='delivered').length,l:'LivrÃ©es',c:'green'},{v:my.filter(m=>m.status==='delivered').reduce((s,m)=>s+(m.prixT||0),0)+' â‚¬',l:'CA',c:'emerald'}].map(s=>'<div class="kpi-card"><div class="kpi-val text-'+s.c+'-600">'+s.v+'</div><div class="kpi-lbl">'+s.l+'</div></div>').join('');
const avail=ms.filter(m=>m.status==='pending'&&elig.includes(m.departement)&&!m.offres.find(o=>o.tId===CU.id));
document.getElementById('tAvailC').innerHTML='<div class="bg-white rounded-2xl shadow-sm border overflow-hidden"><div class="p-4 border-b"><h2 class="text-sm font-bold">Missions zone Dept '+dept+' ('+( DN[dept]||'')+')</h2></div><div class="divide-y">'+(avail.length?avail.map(m=>'<div class="p-4 hover:bg-slate-50"><div class="flex justify-between items-center mb-2"><div><span class="font-bold text-sm">'+m.ref+'</span> <span class="text-xs text-slate-500">'+m.fromCity+' â†’ '+(m.dest?.ville||'?')+'</span></div><span class="text-xs text-slate-400">Dept '+m.departement+'</span></div><div class="text-xs text-slate-600 mb-2">'+m.nature+' â€¢ '+m.poids+'kg â€¢ '+m.um+' UM</div><div class="flex justify-between"><span class="text-xs text-slate-500">ğŸ“… '+m.date+'</span><button onclick="openOffer(\''+m.ref+'\')" class="px-3 py-1.5 bg-green-600 text-white rounded-lg text-xs font-bold">ğŸ“ Offre</button></div></div>').join(''):'<div class="p-6 text-center text-slate-400 text-sm">Aucune mission</div>')+'</div></div>';
document.getElementById('tMyC').innerHTML='<div class="bg-white rounded-2xl shadow-sm border overflow-hidden"><div class="p-4 border-b"><h2 class="text-sm font-bold">Mes missions</h2></div><div class="divide-y">'+(my.length?my.map(m=>'<div class="p-4 hover:bg-slate-50"><div class="flex justify-between items-center mb-1"><div class="flex items-center gap-2"><span class="font-bold text-sm">'+m.ref+'</span><span class="status-'+m.status+' px-2 py-0.5 rounded-full text-xs font-bold">'+sL(m.status)+'</span></div><span class="font-bold text-emerald-600 text-sm">'+(m.prixT||'â€”')+' â‚¬</span></div><div class="text-xs text-slate-600 mb-2">'+m.fromCity+' â†’ '+(m.dest?.ville||'?')+' â€¢ '+m.nature+'</div>'+(m.rejetMotif?'<div class="mb-2 p-2 bg-red-50 border border-red-200 rounded-lg text-xs text-red-800">âŒ <strong>RejetÃ©:</strong> '+m.rejetMotif+'</div>':'')+'<div class="flex gap-1">'+(m.status==='progress'?'<button onclick="openUpload(\''+m.ref+'\')" class="px-3 py-1.5 bg-green-600 text-white rounded-lg text-xs font-bold">ğŸ“· Livraison</button>':'')+(m.status==='pending_delivery'?'<span class="px-3 py-1.5 bg-orange-100 text-orange-800 rounded-lg text-xs font-bold">â³ Validation</span>':'')+(m.status==='delivered'?'<button onclick="genFactureTrans(\''+m.ref+'\')" class="px-3 py-1.5 bg-purple-600 text-white rounded-lg text-xs font-bold">ğŸ’¶ Facture</button>':'')+'</div></div>').join(''):'<div class="p-6 text-center text-slate-400 text-sm">Aucune</div>')+'</div></div>';
showTransTab('available');}
function openOffer(ref){curOfferRef=ref;const m=gM().find(x=>x.ref===ref);document.getElementById('offerInfo').innerHTML='<strong>'+m.ref+'</strong> â€” '+m.fromCity+' â†’ '+(m.dest?.ville||'?')+'<br><span class="text-xs">'+m.nature+' â€¢ '+m.poids+'kg â€¢ EnlÃ¨v: '+m.date+'</span>';const ch=gC(CU.id);document.getElementById('ofChauffeur').innerHTML='<option value="">â€” Moi-mÃªme â€”</option>'+ch.map(c=>'<option value="'+c.id+'">'+c.prenom+' '+c.nom+'</option>').join('');openModal('offerModal');}
function submitOffer(e){e.preventDefault();const ms=gM(),m=ms.find(x=>x.ref===curOfferRef);m.offres.push({tId:CU.id,nom:CU.prenom+' '+CU.nom,dept:CU.departement,prix:parseFloat(document.getElementById('ofPrix').value),datePEC:document.getElementById('ofDatePEC').value,heurePEC:document.getElementById('ofHeurePEC').value,dateLiv:document.getElementById('ofDateLiv').value,heureLiv:document.getElementById('ofHeureLiv').value,chauffeur:document.getElementById('ofChauffeur').value||null,dateO:new Date().toISOString()});sM(ms);closeModal('offerModal');loadTrans();alert('âœ… Offre envoyÃ©e !');}
function openUpload(ref){curUploadRef=ref;document.getElementById('uploadRef').textContent=ref;document.getElementById('uploadS1').classList.remove('hidden');document.getElementById('uploadS2').classList.add('hidden');document.getElementById('photoPreview').innerHTML='';openModal('uploadModal');}
function previewPhotos(e){document.getElementById('photoPreview').innerHTML=Array.from(e.target.files).map(f=>'<div class="aspect-square bg-slate-100 rounded-lg overflow-hidden"><img src="'+URL.createObjectURL(f)+'" class="w-full h-full object-cover"></div>').join('');}
function submitDelivery(){const f=document.getElementById('photoInput').files;if(!f.length){alert('Photo requise');return;}const ms=gM(),m=ms.find(x=>x.ref===curUploadRef);m.status='pending_delivery';m.rejetMotif=null;m.livraison={date:new Date().toISOString(),signataire:document.getElementById('signataire').value||'Non spÃ©cifiÃ©',photos:f.length};const r=new FileReader();r.onload=function(){localStorage.setItem('ph_'+curUploadRef,r.result);};if(f[0])r.readAsDataURL(f[0]);sM(ms);document.getElementById('uploadS1').classList.add('hidden');document.getElementById('uploadS2').classList.remove('hidden');loadTrans();}
function renderTMS(){const ms=gM().filter(m=>m.transporteurId===CU?.id),del=ms.filter(m=>m.status==='delivered'),rej=ms.filter(m=>m.rejetMotif),onTime=del.length?Math.round(del.length/(del.length+rej.length)*100):0,ca=del.reduce((s,m)=>s+(m.prixT||0),0);
document.getElementById('tTmsC').innerHTML='<div class="bg-white rounded-2xl shadow-sm border p-6"><h2 class="text-lg font-bold mb-4">ğŸ“Š TMS</h2><div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">'+[{v:ms.length,l:'Total',c:'blue'},{v:del.length,l:'LivrÃ©es',c:'green'},{v:onTime+'%',l:'RÃ©ussite',c:'emerald'},{v:ca+' â‚¬',l:'CA',c:'purple'}].map(k=>'<div class="kpi-card"><div class="kpi-val text-'+k.c+'-600">'+k.v+'</div><div class="kpi-lbl">'+k.l+'</div></div>').join('')+'</div><h3 class="font-bold text-sm mb-3">Historique</h3><div class="space-y-2">'+ms.map(m=>'<div class="flex items-center justify-between p-3 bg-slate-50 rounded-lg"><div><span class="font-bold text-xs">'+m.ref+'</span> <span class="text-xs text-slate-500">'+m.fromCity+'â†’'+(m.dest?.ville||'?')+'</span></div><div class="flex items-center gap-2"><span class="status-'+m.status+' px-2 py-0.5 rounded-full text-xs font-bold">'+sL(m.status)+'</span><span class="text-xs font-bold text-emerald-600">'+(m.prixT||'â€”')+'â‚¬</span></div></div>').join('')+'</div></div>';}
function renderChauffeurs(){const ch=gC(CU?.id);document.getElementById('tChaufC').innerHTML='<div class="bg-white rounded-2xl shadow-sm border p-6"><div class="flex justify-between items-center mb-4"><h2 class="text-lg font-bold">ğŸ‘¤ Chauffeurs</h2><button onclick="openModal(\'chauffeurModal\')" class="px-4 py-2 bg-blue-600 text-white rounded-lg text-xs font-bold">+ Ajouter</button></div>'+(ch.length?'<div class="space-y-2">'+ch.map(c=>'<div class="flex items-center justify-between p-3 bg-slate-50 rounded-lg"><div><span class="font-bold text-sm">'+c.prenom+' '+c.nom+'</span> <span class="text-xs text-slate-500">Permis: '+c.permis+' ('+c.categorie+')</span>'+(c.validite?' <span class="text-xs text-slate-400">Exp: '+c.validite+'</span>':'')+'</div><button onclick="removeChauffeur('+c.id+')" class="text-red-500 text-xs font-bold hover:underline">Suppr.</button></div>').join('')+'</div>':'<div class="text-sm text-slate-400 text-center p-4">Aucun chauffeur</div>')+'</div>';}
function addChauffeur(e){e.preventDefault();const ch=gC(CU.id);ch.push({id:Date.now(),prenom:document.getElementById('chPrenom').value,nom:document.getElementById('chNom').value,permis:document.getElementById('chPermis').value,categorie:document.getElementById('chCategorie').value,validite:document.getElementById('chValidite').value,tel:document.getElementById('chTel').value});sC(CU.id,ch);closeModal('chauffeurModal');renderChauffeurs();}
function removeChauffeur(id){sC(CU.id,gC(CU.id).filter(c=>c.id!==id));renderChauffeurs();}
function renderCompta(){const ms=gM().filter(m=>m.transporteurId===CU?.id),del=ms.filter(m=>m.status==='delivered'),ca=del.reduce((s,m)=>s+(m.prixT||0),0),tva=ca*.2;
document.getElementById('tComptaC').innerHTML='<div class="bg-white rounded-2xl shadow-sm border p-6"><h2 class="text-lg font-bold mb-4">ğŸ’¶ ComptabilitÃ©</h2><div class="grid grid-cols-3 gap-4 mb-6">'+[{v:ca.toFixed(2)+' â‚¬',l:'CA HT',c:'emerald'},{v:tva.toFixed(2)+' â‚¬',l:'TVA',c:'slate'},{v:(ca+tva).toFixed(2)+' â‚¬',l:'TTC',c:'blue'}].map(k=>'<div class="kpi-card"><div class="kpi-val text-'+k.c+'-600">'+k.v+'</div><div class="kpi-lbl">'+k.l+'</div></div>').join('')+'</div><h3 class="font-bold text-sm mb-3">Factures</h3><div class="space-y-2">'+del.map(m=>'<div class="flex items-center justify-between p-3 bg-slate-50 rounded-lg"><div><span class="font-bold text-xs">'+m.ref+'</span> <span class="text-xs text-slate-500">'+m.fromCity+'â†’'+(m.dest?.ville||'?')+'</span></div><div class="flex items-center gap-2"><span class="text-xs font-bold text-emerald-600">'+m.prixT+' â‚¬</span><button onclick="genFactureTrans(\''+m.ref+'\')" class="px-2 py-1 bg-purple-600 text-white rounded text-xs font-bold">Voir</button></div></div>').join('')+'</div></div>';}
function submitConformity(e){e.preventDefault();CU.transStatus='submitted';CU.conformity={licence:document.getElementById('cfLicence').value,assurDate:document.getElementById('cfAssurDate').value,immatTracteur:document.getElementById('cfImmatTracteur').value,immatRemorque:document.getElementById('cfImmatRemorque').value,tel247:document.getElementById('cfTel247').value,submittedAt:new Date().toISOString()};saveUser(CU);localStorage.setItem('w_cu',JSON.stringify(CU));closeModal('conformityModal');loadTrans();alert('âœ… Dossier soumis !');}
// === ADMIN ===
function showATab(t){document.querySelectorAll('.a-tab').forEach(e=>e.classList.add('hidden'));document.querySelectorAll('[id^="aTab"]').forEach(b=>b.classList.remove('active'));const map={users:'Users',validation:'Validation',offres:'Offres',assign:'Assign',livraisons:'Livraisons',facturation:'Facturation',docs:'Docs'};document.getElementById('a'+map[t]+'C').classList.remove('hidden');document.getElementById('aTab'+map[t]).classList.add('active');({users:renderAUsers,validation:renderAValidation,offres:renderAOffres,assign:renderAAssign,livraisons:renderALivraisons,facturation:renderAFacturation,docs:renderADocs})[t]();}
function loadAdmin(){const ms=gM(),us=gU();document.getElementById('adminStats').innerHTML=[{v:us.length,l:'Utilisateurs',c:'blue'},{v:ms.length,l:'Missions',c:'emerald'},{v:ms.filter(m=>m.status==='pending'&&m.offres.length).length,l:'Offres',c:'yellow'},{v:ms.filter(m=>m.status==='pending_delivery').length,l:'Livraisons',c:'orange'},{v:ms.filter(m=>m.factureEmise).reduce((s,m)=>s+(m.prixC||0),0)+' â‚¬',l:'CA',c:'purple'}].map(s=>'<div class="bg-gradient-to-br from-'+s.c+'-500 to-'+s.c+'-600 p-4 rounded-2xl shadow-lg text-white"><div class="text-xl font-black">'+s.v+'</div><div class="text-'+s.c+'-100 text-xs">'+s.l+'</div></div>').join('');showATab('users');}
function renderAUsers(){let us=gU().filter(u=>!(u.roles||[]).includes('admin'));const f=window.aUserFilter;if(f&&f!=='all')us=us.filter(u=>(u.roles||[]).includes(f));const q=(document.getElementById('aUserSearch')?.value||'').toLowerCase();if(q)us=us.filter(u=>(u.prenom+' '+u.nom+' '+u.email+(u.departement||'')).toLowerCase().includes(q));const sort=document.getElementById('aUserSort')?.value||'nom';us.sort((a,b)=>sort==='dept'?(a.departement||'99').localeCompare(b.departement||'99'):(a.nom||'').localeCompare(b.nom||''));
document.getElementById('aUsersC').innerHTML='<div class="bg-white rounded-2xl shadow-sm border overflow-hidden"><div class="p-4 border-b flex flex-wrap gap-2 items-center justify-between"><div class="flex gap-1"><button onclick="window.aUserFilter=\'all\';renderAUsers()" class="px-3 py-1 rounded-lg text-xs font-bold '+((!f||f==='all')?'bg-blue-600 text-white':'bg-slate-100')+'">Tous</button><button onclick="window.aUserFilter=\'expediteur\';renderAUsers()" class="px-3 py-1 rounded-lg text-xs font-bold '+(f==='expediteur'?'bg-blue-600 text-white':'bg-slate-100')+'">ğŸ“¦ Exp.</button><button onclick="window.aUserFilter=\'transporteur\';renderAUsers()" class="px-3 py-1 rounded-lg text-xs font-bold '+(f==='transporteur'?'bg-emerald-600 text-white':'bg-slate-100')+'">ğŸš› Trans.</button></div><div class="flex gap-1"><input type="text" id="aUserSearch" oninput="renderAUsers()" placeholder="ğŸ” Recherche" class="inp w-40 text-xs"><select id="aUserSort" onchange="renderAUsers()" class="inp w-28 text-xs"><option value="nom">Nom</option><option value="dept">DÃ©partement</option></select></div></div><div class="divide-y">'+us.map(u=>'<div class="p-3 flex items-center justify-between hover:bg-slate-50"><div class="flex items-center gap-3"><div class="w-8 h-8 rounded-lg flex items-center justify-center text-sm font-black '+((u.roles||[]).includes('transporteur')?'bg-emerald-100 text-emerald-600':'bg-blue-100 text-blue-600')+'">'+u.prenom.charAt(0)+'</div><div><div class="font-bold text-xs">'+u.prenom+' '+u.nom+'</div><div class="text-xs text-slate-500">'+u.email+(u.departement?' â€¢ '+u.departement+' '+(DN[u.departement]||''):'')+'</div></div></div><div class="flex items-center gap-2">'+(u.roles||[]).map(r=>'<span class="role-badge text-xs '+(r==='transporteur'?'role-trans':'role-exp')+'">'+r+'</span>').join('')+'<button onclick="openRoleEditor(\''+u.email+'\')" class="px-2 py-1 bg-slate-200 rounded text-xs font-bold">âš™ï¸</button></div></div>').join('')+'</div></div>';}
function openRoleEditor(email){curRoleUserId=email;const u=US[email];document.getElementById('roleUserInfo').innerHTML='<strong>'+u.prenom+' '+u.nom+'</strong> â€” '+u.email;document.getElementById('roleCheckboxes').innerHTML=['expediteur','transporteur'].map(r=>'<div class="check-row"><input type="checkbox" id="role_'+r+'" '+((u.roles||[]).includes(r)?'checked':'')+'><label for="role_'+r+'" class="font-bold text-sm">'+(r==='expediteur'?'ğŸ“¦ ExpÃ©diteur':'ğŸš› Transporteur')+'</label></div>').join('');openModal('roleModal');}
function saveRoles(){const u=US[curRoleUserId],nr=[];if(document.getElementById('role_expediteur').checked)nr.push('expediteur');if(document.getElementById('role_transporteur').checked)nr.push('transporteur');if((u.roles||[]).includes('admin'))nr.push('admin');u.roles=nr;saveUser(u);closeModal('roleModal');renderAUsers();alert('âœ… RÃ´les mis Ã  jour');}
function renderAValidation(){const pending=gU().filter(u=>(u.roles||[]).includes('transporteur')&&(u.transStatus==='submitted'||u.transStatus==='pending_validation'));document.getElementById('aValidationC').innerHTML='<div class="bg-white rounded-2xl shadow-sm border overflow-hidden"><div class="p-4 border-b"><h2 class="text-sm font-bold">ConformitÃ© ('+pending.length+')</h2></div><div class="divide-y">'+(pending.length?pending.map(u=>'<div class="p-4"><div class="flex justify-between items-start mb-3"><div><span class="font-bold">'+u.prenom+' '+u.nom+'</span> <span class="text-xs text-slate-500">'+u.email+' â€¢ Dept '+u.departement+'</span></div><span class="status-pending_validation px-2 py-1 rounded-full text-xs font-bold">'+(u.transStatus==='submitted'?'Soumis':'En attente')+'</span></div>'+(u.conformity?'<div class="p-3 bg-slate-50 rounded-lg text-xs mb-3"><strong>Licence:</strong> '+u.conformity.licence+' â€¢ <strong>Immat:</strong> '+u.conformity.immatTracteur+' â€¢ <strong>Tel 24/7:</strong> '+u.conformity.tel247+'</div><div class="flex gap-2"><button onclick="validateTransporteur(\''+u.email+'\')" class="px-3 py-1.5 bg-green-600 text-white rounded-lg text-xs font-bold">âœ… Valider</button><button onclick="rejectTransporteur(\''+u.email+'\')" class="px-3 py-1.5 bg-red-500 text-white rounded-lg text-xs font-bold">âŒ Refuser</button></div>':'<div class="text-xs text-slate-400 italic">Dossier non soumis</div>')+'</div>').join(''):'<div class="p-6 text-center text-slate-400 text-sm">Aucun</div>')+'</div></div>';}
function validateTransporteur(email){const u=US[email];u.transStatus='validated';saveUser(u);renderAValidation();alert('âœ… ValidÃ©');}
function rejectTransporteur(email){const motif=prompt('Motif:');if(!motif)return;const u=US[email];u.transStatus='rejected';u.rejectMotif=motif;saveUser(u);renderAValidation();}
function renderAOffres(){const ms=gM().filter(m=>m.status==='pending');document.getElementById('aOffresC').innerHTML='<div class="bg-white rounded-2xl shadow-sm border overflow-hidden"><div class="p-4 border-b"><h2 class="text-sm font-bold">Offres</h2></div><div class="divide-y">'+(ms.length?ms.map(m=>'<div class="p-4"><div class="flex justify-between items-center mb-2"><div><span class="font-bold text-sm">'+m.ref+'</span> <span class="text-xs text-slate-500">'+m.fromCity+'â†’'+(m.dest?.ville||'?')+' (Dept '+m.departement+')</span></div><span class="text-xs font-bold '+(m.offres.length?'text-green-600':'text-slate-400')+'">'+m.offres.length+' offre(s)</span></div>'+(m.offres.length?'<div class="space-y-1 mb-3">'+m.offres.map(o=>'<div class="offer-card flex items-center justify-between p-2"><div><span class="font-bold text-xs">'+o.nom+'</span> <span class="text-xs text-slate-400">Dept '+o.dept+'</span><div class="text-xs text-slate-500">'+o.datePEC+' '+o.heurePEC+' â†’ '+o.dateLiv+' '+o.heureLiv+'</div></div><span class="font-black text-emerald-600">'+o.prix+'â‚¬</span></div>').join('')+'</div><button onclick="openCompose(\''+m.ref+'\')" class="px-3 py-1.5 bg-blue-600 text-white rounded-lg text-xs font-bold">ğŸ“¨ Devis</button>':'<div class="text-xs text-slate-400">Zones: '+eligDepts(m.departement).join(', ')+'</div>')+'</div>').join(''):'<div class="p-6 text-center text-slate-400 text-sm">Aucune</div>')+'</div></div>';}
function openCompose(ref){curComposeRef=ref;devisCnt=0;const m=gM().find(x=>x.ref===ref);document.getElementById('composeInfo').innerHTML='<strong>'+m.ref+'</strong> â€” '+m.fromCity+'â†’'+(m.dest?.ville||'?')+' â€¢ '+m.nature+' â€¢ '+m.poids+'kg';document.getElementById('composeOffres').innerHTML=m.offres.map(o=>'<div class="text-xs p-2 bg-white border rounded mb-1"><strong>'+o.nom+'</strong> â€” <span class="text-emerald-600 font-bold">'+o.prix+'â‚¬</span> â€” '+o.datePEC+'â†’'+o.dateLiv+'</div>').join('');document.getElementById('composeFields').innerHTML='';document.getElementById('addDevisBtn').classList.remove('hidden');addDevisRow();openModal('composeModal');}
function addDevisRow(){if(devisCnt>=3)return;devisCnt++;document.getElementById('composeFields').insertAdjacentHTML('beforeend','<div class="p-3 border-2 border-slate-200 rounded-xl"><span class="font-bold text-xs">Proposition '+devisCnt+'</span><div class="grid grid-cols-2 gap-2 mt-2"><div><label class="text-xs font-bold text-slate-500">Prix HT (â‚¬)</label><input type="number" id="dp'+devisCnt+'" class="inp text-sm"></div><div><label class="text-xs font-bold text-slate-500">DÃ©lai</label><input type="text" id="dd'+devisCnt+'" class="inp text-sm" placeholder="2-3 jours"></div></div></div>');if(devisCnt>=3)document.getElementById('addDevisBtn').classList.add('hidden');}
function sendDevis(){const ms=gM(),m=ms.find(x=>x.ref===curComposeRef);m.devis=[];for(let i=1;i<=devisCnt;i++){const p=parseFloat(document.getElementById('dp'+i).value),d=document.getElementById('dd'+i).value;if(!p||!d){alert('Champs requis');return;}m.devis.push({id:i,prixC:p,delai:d});}m.status='quoted';sM(ms);closeModal('composeModal');loadAdmin();alert('âœ… Devis envoyÃ© !');}
function renderAAssign(){const ms=gM().filter(m=>m.status==='accepted');document.getElementById('aAssignC').innerHTML='<div class="bg-white rounded-2xl shadow-sm border overflow-hidden"><div class="p-4 border-b"><h2 class="text-sm font-bold">Assignation ('+ms.length+')</h2></div><div class="divide-y">'+(ms.length?ms.map(m=>{const dv=m.devis[m.devisChoisi],elig=gT().filter(t=>eligDepts(m.departement).includes(t.departement)),om={};m.offres.forEach(o=>om[o.tId]=o);return'<div class="p-4"><div class="flex justify-between mb-2"><div><span class="font-bold text-sm">'+m.ref+'</span> â€” '+m.fromCity+'â†’'+(m.dest?.ville||'?')+'</div><div class="text-right"><div class="text-xs text-slate-500">Prix client</div><div class="font-black text-blue-600">'+(dv?.prixC||'?')+' â‚¬</div></div></div><div class="mb-2"><label class="lbl">Transporteur</label><select id="as_'+m.ref+'" class="inp text-sm"><option value="">Choisir...</option>'+elig.map(t=>{const o=om[t.id];return'<option value="'+t.id+'">'+t.prenom+' '+t.nom+' ('+t.departement+')'+(o?' â€” '+o.prix+'â‚¬':'')+'</option>';}).join('')+'</select></div><button onclick="assignMission(\''+m.ref+'\')" class="px-3 py-1.5 bg-green-600 text-white rounded-lg text-xs font-bold">âœ… Assigner</button></div>';}).join(''):'<div class="p-6 text-center text-slate-400 text-sm">Aucune</div>')+'</div></div>';}
function assignMission(ref){const sel=document.getElementById('as_'+ref);if(!sel.value){alert('Choisir');return;}const tid=parseInt(sel.value),t=gU().find(u=>u.id===tid),ms=gM(),m=ms.find(x=>x.ref===ref),o=m.offres.find(x=>x.tId===tid);m.transporteurId=tid;m.transporteurNom=t.prenom+' '+t.nom;m.prixT=o?o.prix:null;m.status='progress';sM(ms);loadAdmin();alert('âœ… AssignÃ©');}
function renderALivraisons(){const ms=gM().filter(m=>m.status==='pending_delivery');document.getElementById('aLivraisonsC').innerHTML='<div class="bg-white rounded-2xl shadow-sm border overflow-hidden"><div class="p-4 border-b"><h2 class="text-sm font-bold">Livraisons ('+ms.length+')</h2></div><div class="divide-y">'+(ms.length?ms.map(m=>'<div class="p-4"><div class="flex justify-between mb-2"><div><span class="font-bold text-sm">'+m.ref+'</span> '+m.fromCity+'â†’'+(m.dest?.ville||'?')+'<div class="text-xs text-slate-500">Trans: '+m.transporteurNom+' â€¢ Client: '+m.expediteurNom+'</div></div></div>'+(m.livraison?'<div class="mb-2 text-xs">ğŸ“· '+m.livraison.photos+' photo(s) <button onclick="viewPhotos(\''+m.ref+'\')" class="text-blue-600 underline">Voir</button> â€¢ Signataire: '+m.livraison.signataire+'</div>':'')+'<div class="flex gap-3 text-xs mb-2"><span>Trans: <strong class="text-emerald-600">'+(m.prixT||'â€”')+'â‚¬</strong></span><span>Client: <strong class="text-blue-600">'+(m.prixC||'â€”')+'â‚¬</strong></span>'+(m.prixT&&m.prixC?'<span>Marge: <strong class="text-purple-600">'+(m.prixC-m.prixT)+'â‚¬</strong></span>':'')+'</div><div class="flex gap-2"><button onclick="validateDel(\''+m.ref+'\')" class="px-3 py-1.5 bg-green-600 text-white rounded-lg text-xs font-bold">âœ…</button><button onclick="openReject(\''+m.ref+'\')" class="px-3 py-1.5 bg-red-500 text-white rounded-lg text-xs font-bold">âŒ</button></div></div>').join(''):'<div class="p-6 text-center text-slate-400 text-sm">Aucune</div>')+'</div></div>';}
function validateDel(ref){const ms=gM(),m=ms.find(x=>x.ref===ref);m.status='delivered';m.factureEmise=true;sM(ms);loadAdmin();alert('âœ… ValidÃ©e');}
function openReject(ref){curRejectRef=ref;document.getElementById('rejectMotif').value='';openModal('rejectModal');}
function confirmReject(){const mt=document.getElementById('rejectMotif').value.trim();if(!mt){alert('Motif requis');return;}const ms=gM(),m=ms.find(x=>x.ref===curRejectRef);m.status='progress';m.rejetMotif=mt;m.livraison=null;sM(ms);closeModal('rejectModal');loadAdmin();alert('âŒ RejetÃ©');}
function renderAFacturation(){const ms=gM().filter(m=>m.factureEmise);document.getElementById('aFacturationC').innerHTML='<div class="bg-white rounded-2xl shadow-sm border overflow-hidden"><div class="p-4 border-b"><h2 class="text-sm font-bold">Factures</h2></div><div class="divide-y">'+(ms.length?ms.map(m=>'<div class="p-3 flex justify-between items-center hover:bg-slate-50"><div><span class="font-bold text-xs">'+m.ref+'</span> â€” '+m.expediteurNom+'</div><div class="flex items-center gap-3"><span class="font-bold text-blue-600 text-sm">'+m.prixC+' â‚¬</span><button onclick="viewInvoiceClient(\''+m.ref+'\')" class="px-2 py-1 bg-blue-600 text-white rounded text-xs font-bold">Voir</button></div></div>').join(''):'<div class="p-6 text-center text-slate-400 text-sm">Aucune</div>')+'</div></div>';}
function renderADocs(){const ms=gM().filter(m=>m.transporteurId);document.getElementById('aDocsC').innerHTML='<div class="bg-white rounded-2xl shadow-sm border overflow-hidden"><div class="p-4 border-b"><h2 class="text-sm font-bold">Documents</h2></div><div class="divide-y">'+(ms.length?ms.map(m=>'<div class="p-3 flex justify-between items-center hover:bg-slate-50"><div><span class="font-bold text-xs">'+m.ref+'</span> '+m.fromCity+'â†’'+(m.dest?.ville||'?')+'<div class="text-xs text-slate-500">'+m.transporteurNom+'</div></div><div class="flex gap-1"><button onclick="genAttestation(\''+m.ref+'\')" class="px-2 py-1 bg-orange-600 text-white rounded text-xs font-bold">Attest.</button><button onclick="genCMR(\''+m.ref+'\')" class="px-2 py-1 bg-blue-600 text-white rounded text-xs font-bold">CMR</button></div></div>').join(''):'<div class="p-6 text-center text-slate-400 text-sm">Aucune</div>')+'</div></div>';}
// === DOCUMENTS ===
function viewPhotos(ref){const p=localStorage.getItem('ph_'+ref);if(p){const w=window.open();w.document.write('<img src="'+p+'" style="max-width:100%">');}else alert('Aucune photo');}
function showDoc(h){document.getElementById('docContent').innerHTML=h;openModal('docModal');}
function viewInvoiceClient(ref){const m=gM().find(x=>x.ref===ref);if(!m)return;const ht=m.prixC,tva=ht*.2,ttc=ht+tva;showDoc('<div style="font-family:Arial;max-width:800px;margin:auto;padding:20px"><div style="display:flex;justify-content:space-between;margin-bottom:40px"><div><h1 style="font-size:28px;color:#1e40af;margin:0">FACTURE</h1><p style="font-size:13px">NÂ° F-'+m.ref.replace('WASL-','2025-')+'</p><p style="font-size:13px">'+new Date().toLocaleDateString('fr-FR')+'</p></div><div style="text-align:right"><h2 style="margin:0;color:#1e40af;font-size:18px">WASL TRANSPORT</h2><p style="font-size:12px">123 Av. Champs-Ã‰lysÃ©es, 75008 Paris</p></div></div><div style="background:#eff6ff;padding:12px;border-radius:8px;margin-bottom:25px;border-left:4px solid #1e40af"><p style="font-size:11px;color:#64748b;margin:0">FacturÃ© Ã  :</p><p style="font-weight:bold;margin:4px 0 0;font-size:16px">'+m.expediteurNom+'</p></div><table style="width:100%;border-collapse:collapse;margin-bottom:25px"><thead><tr style="background:#1e40af;color:#fff"><th style="padding:10px;text-align:left;font-size:13px">Description</th><th style="padding:10px;text-align:right;font-size:13px">HT</th></tr></thead><tbody><tr style="border-bottom:1px solid #e2e8f0"><td style="padding:10px"><div style="font-weight:bold;font-size:13px">Prestation de transport '+(m.type==='aerien'?'aÃ©rien':'routier')+'</div><div style="font-size:11px">RÃ©f: '+m.ref+' â€” '+m.fromCity+' â†’ '+(m.dest?.ville||'?')+'</div><div style="font-size:11px;color:#64748b">'+m.nature+' â€” '+m.um+' UM â€” '+m.poids+' kg</div></td><td style="padding:10px;text-align:right">'+ht.toFixed(2)+' â‚¬</td></tr></tbody></table><div style="width:280px;margin-left:auto;font-size:13px"><div style="display:flex;justify-content:space-between;margin-bottom:6px"><span>HT:</span><span>'+ht.toFixed(2)+' â‚¬</span></div><div style="display:flex;justify-content:space-between;margin-bottom:6px"><span>TVA 20%:</span><span>'+tva.toFixed(2)+' â‚¬</span></div><div style="display:flex;justify-content:space-between;font-size:18px;font-weight:bold;border-top:3px solid #1e40af;padding-top:10px"><span>TTC:</span><span>'+ttc.toFixed(2)+' â‚¬</span></div></div><div style="margin-top:30px;padding:12px;background:#f8fafc;border:1px solid #e2e8f0;border-radius:8px;font-size:11px;color:#64748b">Paiement Ã  30 jours â€¢ IBAN: FR76 XXXX XXXX XXXX</div></div>');}
function genFactureTrans(ref){const m=gM().find(x=>x.ref===ref);if(!m)return;const t=CU||gU().find(u=>u.id===m.transporteurId),ht=m.prixT||0,tva=ht*.2,ttc=ht+tva;showDoc('<div style="font-family:Arial;max-width:800px;margin:auto;padding:20px"><div style="display:flex;justify-content:space-between;margin-bottom:40px"><div><h1 style="font-size:28px;color:#166534;margin:0">FACTURE</h1><p style="font-size:13px">NÂ° FT-'+m.ref.replace('WASL-','2025-')+'</p><p style="font-size:13px">'+new Date().toLocaleDateString('fr-FR')+'</p></div><div style="text-align:right"><h2 style="margin:0;color:#166534;font-size:18px">'+t.prenom+' '+t.nom+'</h2><p style="font-size:12px">Transporteur â€¢ '+t.email+'</p></div></div><div style="background:#f0fdf4;padding:12px;border-radius:8px;margin-bottom:25px;border-left:4px solid #166534"><p style="font-size:11px;margin:0;color:#64748b">FacturÃ© Ã  :</p><p style="font-weight:bold;margin:4px 0 0;font-size:16px">WASL TRANSPORT</p></div><table style="width:100%;border-collapse:collapse;margin-bottom:25px"><thead><tr style="background:#166534;color:#fff"><th style="padding:10px;text-align:left;font-size:13px">Prestation</th><th style="padding:10px;text-align:right;font-size:13px">HT</th></tr></thead><tbody><tr style="border-bottom:1px solid #e2e8f0"><td style="padding:10px"><div style="font-weight:bold;font-size:13px">Mission '+m.ref+' â€” '+m.fromCity+'â†’'+(m.dest?.ville||'?')+'</div><div style="font-size:11px;color:#64748b">'+m.nature+' â€” '+m.um+' UM â€” '+m.poids+' kg</div></td><td style="padding:10px;text-align:right">'+ht.toFixed(2)+' â‚¬</td></tr></tbody></table><div style="width:280px;margin-left:auto;font-size:13px"><div style="display:flex;justify-content:space-between;margin-bottom:6px"><span>HT:</span><span>'+ht.toFixed(2)+' â‚¬</span></div><div style="display:flex;justify-content:space-between;margin-bottom:6px"><span>TVA 20%:</span><span>'+tva.toFixed(2)+' â‚¬</span></div><div style="display:flex;justify-content:space-between;font-size:18px;font-weight:bold;border-top:3px solid #166534;padding-top:10px"><span>TTC:</span><span>'+ttc.toFixed(2)+' â‚¬</span></div></div></div>');}
function genAttestation(ref){const m=gM().find(x=>x.ref===ref);if(!m)return;showDoc('<div style="font-family:Arial;max-width:800px;margin:auto;padding:40px"><div style="text-align:center"><h2 style="color:#1e40af;margin:0">WASL TRANSPORT</h2><p style="font-size:11px;color:#64748b">Commissionnaire de Transport â€” 123 Av. Champs-Ã‰lysÃ©es, 75008 Paris</p></div><hr style="margin:15px 0"><h1 style="text-align:center;font-size:24px;color:#1e40af;margin-bottom:30px">ATTESTATION DE TRANSPORT</h1><p style="line-height:1.8;font-size:13px">Nous, <strong>WASL TRANSPORT</strong>, attestons que le transporteur :</p><div style="margin:15px 0;padding:12px;background:#f0fdf4;border-left:4px solid #166534;border-radius:0 8px 8px 0"><p style="font-size:16px;font-weight:bold;color:#166534;margin:0">'+(m.transporteurNom||'â€”')+'</p></div><p style="line-height:1.8;font-size:13px">a effectuÃ©, <strong>pour le compte de WASL TRANSPORT</strong>, le transport pour <strong>'+m.expediteurNom+'</strong> :</p><div style="margin:15px 0;padding:15px;background:#f8fafc;border-left:4px solid #1e40af;border-radius:0 8px 8px 0;font-size:13px"><table style="width:100%"><tr><td style="padding:4px 0;color:#64748b;width:140px">RÃ©f:</td><td><strong>'+m.ref+'</strong></td></tr><tr><td style="color:#64748b">Type:</td><td>'+(m.type==='aerien'?'AÃ©rien':'Routier')+'</td></tr><tr><td style="color:#64748b">Trajet:</td><td>'+m.fromCity+' â†’ '+(m.dest?.ville||'?')+'</td></tr><tr><td style="color:#64748b">Marchandise:</td><td>'+m.nature+' â€” '+m.poids+' kg</td></tr>'+(m.livraison?'<tr><td style="color:#64748b">LivrÃ© le:</td><td style="color:#166534;font-weight:bold">'+new Date(m.livraison.date).toLocaleDateString('fr-FR')+'</td></tr>':'')+'</table></div><div style="margin-top:40px;text-align:right"><p>Paris, le '+new Date().toLocaleDateString('fr-FR')+'</p><p style="margin-top:30px;font-weight:bold">WASL TRANSPORT</p></div></div>');}
function genCMR(ref){const m=gM().find(x=>x.ref===ref);if(!m)return;const t=gU().find(u=>u.id===m.transporteurId),cf=t?.conformity||{};
showDoc('<div style="font-family:Arial;max-width:900px;margin:auto;border:2px solid #000;padding:15px;font-size:12px"><div style="text-align:center;border-bottom:2px solid #000;padding-bottom:8px;margin-bottom:10px"><h1 style="font-size:16px;margin:0">LETTRE DE VOITURE INTERNATIONALE â€” CMR</h1><p style="font-size:10px;margin:2px 0">INTERNATIONAL CONSIGNMENT NOTE</p><p style="font-size:9px;color:#666">Convention CMR â€” Transport international de marchandises par route</p></div><div style="display:grid;grid-template-columns:1fr 1fr;border:1px solid #000"><div style="border-right:1px solid #000;border-bottom:1px solid #000;padding:8px"><div style="font-size:10px;color:#666"><strong>1</strong> ExpÃ©diteur / Sender</div><strong>'+m.expediteurNom+'</strong><br>'+m.fromAddr+'<br>'+m.fromCity+'</div><div style="border-bottom:1px solid #000;padding:8px"><div style="font-size:10px;color:#666"><strong>16</strong> Transporteur / Carrier</div><strong>'+(m.transporteurNom||'â€”')+'</strong><br>'+(cf.licence?'Licence: '+cf.licence+'<br>':'')+(cf.immatTracteur?'Immat: '+cf.immatTracteur+'<br>':'')+(t?.tel||cf.tel247||'')+'</div><div style="border-right:1px solid #000;border-bottom:1px solid #000;padding:8px"><div style="font-size:10px;color:#666"><strong>2</strong> Destinataire / Consignee</div><strong>'+(m.dest?.nom||'â€”')+'</strong><br>'+(m.dest?.addr1||'')+'<br>'+(m.dest?.cp||'')+' '+(m.dest?.ville||'')+', '+(m.dest?.pays||'FR')+'</div><div style="border-bottom:1px solid #000;padding:8px"><div style="font-size:10px;color:#666"><strong>17</strong> Transporteurs successifs / Successive carriers</div></div><div style="border-right:1px solid #000;border-bottom:1px solid #000;padding:8px"><div style="font-size:10px;color:#666"><strong>3</strong> Lieu de livraison / Place of delivery</div>'+(m.dest?.addr1||'')+'<br>'+(m.dest?.cp||'')+' '+(m.dest?.ville||'')+', '+(m.dest?.pays||'FR')+'</div><div style="border-bottom:1px solid #000;padding:8px;min-height:50px"><div style="font-size:10px;color:#666"><strong>18</strong> RÃ©serves / Reservations</div></div><div style="border-right:1px solid #000;border-bottom:1px solid #000;padding:8px"><div style="font-size:10px;color:#666"><strong>4</strong> Prise en charge / Taking over</div>'+m.fromCity+', '+m.date+'</div><div style="border-bottom:1px solid #000;padding:8px"><div style="font-size:10px;color:#666"><strong>5</strong> Documents / Docs</div>'+(m.numBL?'BL: '+m.numBL:'')+'</div></div><table style="width:100%;border-collapse:collapse;border:1px solid #000;border-top:none"><thead><tr style="background:#f0f0f0;font-size:10px"><th style="border:1px solid #000;padding:4px">6 Marques/Marks</th><th style="border:1px solid #000;padding:4px">7 Nombre/Number</th><th style="border:1px solid #000;padding:4px">8 Emballage/Pack.</th><th style="border:1px solid #000;padding:4px">9 Nature/Description</th><th style="border:1px solid #000;padding:4px">10 Stat.</th><th style="border:1px solid #000;padding:4px">11 Poids/Weight kg</th><th style="border:1px solid #000;padding:4px">12 Volume mÂ³</th></tr></thead><tbody><tr style="font-size:11px"><td style="border:1px solid #000;padding:6px">'+m.ref+'</td><td style="border:1px solid #000;padding:6px;text-align:center">'+m.um+'</td><td style="border:1px solid #000;padding:6px">â€”</td><td style="border:1px solid #000;padding:6px">'+m.nature+'</td><td style="border:1px solid #000;padding:6px">â€”</td><td style="border:1px solid #000;padding:6px;text-align:center">'+m.poids+'</td><td style="border:1px solid #000;padding:6px;text-align:center">'+(m.volume||'â€”')+'</td></tr></tbody></table><div style="display:grid;grid-template-columns:1fr 1fr;border:1px solid #000;border-top:none"><div style="border-right:1px solid #000;border-bottom:1px solid #000;padding:8px;min-height:40px"><div style="font-size:10px;color:#666"><strong>13</strong> Instructions / Instructions</div>'+(m.instructions||'')+'</div><div style="border-bottom:1px solid #000;padding:8px"><div style="font-size:10px;color:#666"><strong>19</strong> Conventions / Agreements</div></div><div style="border-right:1px solid #000;padding:8px"><div style="font-size:10px;color:#666"><strong>21</strong> Ã‰tabli Ã  / Established in</div><strong>'+m.fromCity+'</strong>, '+new Date().toLocaleDateString('fr-FR')+'<div style="margin-top:20px;display:grid;grid-template-columns:1fr 1fr;gap:10px"><div style="border-top:1px solid #000;padding-top:4px;text-align:center;font-size:9px">ExpÃ©diteur/Sender</div><div style="border-top:1px solid #000;padding-top:4px;text-align:center;font-size:9px">Transporteur/Carrier</div></div></div><div style="padding:8px"><div style="font-size:10px;color:#666"><strong>24</strong> ReÃ§u / Received</div><div style="margin-top:20px;border-top:1px solid #000;padding-top:4px;text-align:center;font-size:9px">Destinataire/Consignee</div></div></div><div style="text-align:center;font-size:9px;color:#999;margin-top:8px">WASL TRANSPORT â€” 123 Av. Champs-Ã‰lysÃ©es, 75008 Paris</div></div>');}
function genDeclValeur(ref){const m=gM().find(x=>x.ref===ref);if(!m)return;showDoc('<div style="font-family:Arial;max-width:800px;margin:auto;padding:20px;border:2px solid #000"><h1 style="text-align:center">DÃ‰CLARATION DE VALEUR</h1><p style="text-align:center;font-weight:bold">RÃ©f: '+m.ref+'</p><p><strong>Je soussignÃ©(e)</strong> '+m.expediteurNom+'</p><p>DÃ©clare que la marchandise a une valeur de :</p><div style="text-align:center;font-size:22px;font-weight:bold;margin:20px 0;padding:15px;background:#f0f0f0">'+(m.valeur||m.poids*50).toFixed(2)+' '+(m.devise||'EUR')+'</div><p><strong>Description:</strong> '+m.nature+'</p><p><strong>Poids:</strong> '+m.poids+' kg â€¢ <strong>UM:</strong> '+m.um+'</p><div style="margin-top:50px;text-align:right"><p>'+m.fromCity+', le '+new Date().toLocaleDateString('fr-FR')+'</p><div style="margin-top:30px;border-top:1px solid #000;padding-top:8px;display:inline-block;min-width:180px">Signature</div></div></div>');}
// === MODALS ===
function openModal(id){document.getElementById(id).classList.add('active');document.body.style.overflow='hidden';}
function closeModal(id){document.getElementById(id).classList.remove('active');document.body.style.overflow='';}
function switchModal(a,b){closeModal(a);setTimeout(function(){openModal(b);},200);}
function resetLocalStorage(){if(confirm('âš ï¸ RÃ©initialiser toutes les donnÃ©es ?')){localStorage.clear();location.reload();}}
function handleDemande(e){e.preventDefault();const fc=document.getElementById('dFromCity').value,dept=getDept(fc);
const m={ref:'WASL-'+Date.now().toString().slice(-6),expediteurId:CU?.id,expediteurNom:CU.prenom+' '+CU.nom,type:document.getElementById('dType').value,fromCity:fc,fromAddr:document.getElementById('dFromAddr').value,dest:{code:document.getElementById('dDestCode').value,nom:document.getElementById('dDestNom').value,addr1:document.getElementById('dDestAddr1').value,addr2:document.getElementById('dDestAddr2').value,cp:document.getElementById('dDestCP').value,ville:document.getElementById('dDestVille').value,region:document.getElementById('dDestRegion').value,pays:document.getElementById('dDestPays').value,tel:document.getElementById('dDestTel').value,email:document.getElementById('dDestEmail').value,motDir:document.getElementById('dDestMotDir').value,contact:document.getElementById('dDestContact').value},departement:dept,nature:document.getElementById('dNature').value,um:parseInt(document.getElementById('dUM').value)||0,poids:parseFloat(document.getElementById('dPoids').value)||0,longueur:parseFloat(document.getElementById('dLongueur').value)||0,volume:parseFloat(document.getElementById('dVolume').value)||0,valeur:parseFloat(document.getElementById('dValeur').value)||0,devise:document.getElementById('dDevise').value,numBL:document.getElementById('dNumBL').value,refDest:document.getElementById('dRefDest')?.value||'',date:document.getElementById('dDate').value,instructions:document.getElementById('dInstructions').value,remarques:document.getElementById('dRemarques').value,status:'pending',offres:[],devis:[],devisChoisi:null,transporteurId:null,transporteurNom:null,prixT:null,prixC:null,livraison:null,rejetMotif:null,factureEmise:false};
if(!dept){const d=prompt('Ville non reconnue. Code dÃ©partement (ex: 64):');if(d)m.departement=d;else{alert('DÃ©partement requis');return;}}
const ms=gM();ms.push(m);sM(ms);closeModal('demandeModal');loadExp();alert('âœ… '+m.ref+' crÃ©Ã©e â€” Zones: '+eligDepts(m.departement).join(', '));}
// === INIT ===
document.addEventListener('DOMContentLoaded',function(){initData();const sel=document.getElementById('regDept');Object.keys(DN).sort().forEach(function(k){const o=document.createElement('option');o.value=k;o.textContent=k+' â€” '+DN[k];sel.appendChild(o);});const s=localStorage.getItem('w_cu');if(s){CU=JSON.parse(s);const r=CU.roles||[];activeRole=r.includes('admin')?'admin':r.includes('expediteur')?'expediteur':r.includes('transporteur')?'transporteur':'';showNav();showDash();}});
window.addEventListener('scroll',function(){const n=document.getElementById('navbar');if(window.scrollY>100&&!CU){n.classList.add('nav-scrolled');document.getElementById('navBrand').className='text-2xl font-black text-slate-900';}else if(!CU){n.classList.remove('nav-scrolled');document.getElementById('navBrand').className='text-2xl font-black text-white';}});

</script>
</body>
</html>
